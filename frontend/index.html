<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCON Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230f172a'/%3E%3Crect x='4' y='4' width='56' height='56' rx='8' fill='%231e293b' stroke='%2338bdf8' stroke-width='2'/%3E%3Ctext x='32' y='44' text-anchor='middle' font-family='monospace' font-size='28' font-weight='bold' fill='%2338bdf8'%3E%3E_%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        :root {
            --bg-body: #0a0f1a;
            --bg-header: rgba(15,23,42,0.8);
            --bg-sidebar: rgba(15,23,42,0.5);
            --bg-card: rgba(30,41,59,0.5);
            --bg-card-hover: #1e293b;
            --bg-console: #020617;
            --bg-input: #0f172a;
            --border-color: rgba(51,65,85,0.5);
            --border-header: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-dim: #475569;
            --accent: #38bdf8;
            --accent-hover: #7dd3fc;
            --accent-glow: rgba(56,189,248,0.15);
            --scrollbar-track: #0f172a;
            --scrollbar-thumb: #334155;
        }
        [data-theme="ocean"] {
            --bg-body: #0a1628;
            --bg-header: rgba(10,30,60,0.85);
            --bg-sidebar: rgba(10,25,50,0.6);
            --bg-card: rgba(15,40,75,0.5);
            --bg-card-hover: #0f3460;
            --bg-console: #050e1f;
            --bg-input: #0a1e3c;
            --border-color: rgba(30,80,140,0.4);
            --border-header: #0f3460;
            --accent: #06b6d4;
            --accent-hover: #67e8f9;
            --accent-glow: rgba(6,182,212,0.15);
            --scrollbar-track: #0a1e3c;
            --scrollbar-thumb: #1e4976;
        }
        [data-theme="emerald"] {
            --bg-body: #071a12;
            --bg-header: rgba(7,26,18,0.85);
            --bg-sidebar: rgba(7,26,18,0.6);
            --bg-card: rgba(13,47,33,0.5);
            --bg-card-hover: #0d2f21;
            --bg-console: #030f09;
            --bg-input: #0a2318;
            --border-color: rgba(20,80,55,0.5);
            --border-header: #14503a;
            --accent: #34d399;
            --accent-hover: #6ee7b7;
            --accent-glow: rgba(52,211,153,0.15);
            --scrollbar-track: #0a2318;
            --scrollbar-thumb: #14503a;
        }
        [data-theme="sunset"] {
            --bg-body: #1a0a0f;
            --bg-header: rgba(30,12,18,0.85);
            --bg-sidebar: rgba(30,12,18,0.6);
            --bg-card: rgba(55,20,35,0.5);
            --bg-card-hover: #3b1425;
            --bg-console: #0f0508;
            --bg-input: #2a0e18;
            --border-color: rgba(100,30,55,0.5);
            --border-header: #5c1a35;
            --accent: #f472b6;
            --accent-hover: #f9a8d4;
            --accent-glow: rgba(244,114,182,0.15);
            --scrollbar-track: #2a0e18;
            --scrollbar-thumb: #5c1a35;
        }
        [data-theme="amber"] {
            --bg-body: #1a150a;
            --bg-header: rgba(30,24,10,0.85);
            --bg-sidebar: rgba(30,24,10,0.6);
            --bg-card: rgba(55,43,18,0.5);
            --bg-card-hover: #3b2b12;
            --bg-console: #0f0b05;
            --bg-input: #2a200d;
            --border-color: rgba(100,75,25,0.5);
            --border-header: #5c4a18;
            --accent: #fbbf24;
            --accent-hover: #fcd34d;
            --accent-glow: rgba(251,191,36,0.15);
            --scrollbar-track: #2a200d;
            --scrollbar-thumb: #5c4a18;
        }
        [data-theme="violet"] {
            --bg-body: #10061a;
            --bg-header: rgba(18,8,30,0.85);
            --bg-sidebar: rgba(18,8,30,0.6);
            --bg-card: rgba(35,15,60,0.5);
            --bg-card-hover: #2a1045;
            --bg-console: #080310;
            --bg-input: #1a0a2e;
            --border-color: rgba(60,25,100,0.5);
            --border-header: #3c1964;
            --accent: #a78bfa;
            --accent-hover: #c4b5fd;
            --accent-glow: rgba(167,139,250,0.15);
            --scrollbar-track: #1a0a2e;
            --scrollbar-thumb: #3c1964;
        }
        [data-theme="dark"] {
            --bg-body: #111111;
            --bg-header: rgba(24,24,24,0.9);
            --bg-sidebar: rgba(24,24,24,0.6);
            --bg-card: rgba(38,38,38,0.6);
            --bg-card-hover: #2a2a2a;
            --bg-console: #0a0a0a;
            --bg-input: #1a1a1a;
            --border-color: rgba(60,60,60,0.5);
            --border-header: #2a2a2a;
            --text-primary: #d4d4d4;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            --text-dim: #525252;
            --accent: #e5e5e5;
            --accent-hover: #ffffff;
            --accent-glow: rgba(255,255,255,0.08);
            --scrollbar-track: #1a1a1a;
            --scrollbar-thumb: #404040;
        }
        body { background-color: var(--bg-body); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        .console-font { font-family: 'JetBrains Mono', monospace; }
        .weather-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-console, #1e293b);
            outline: none;
            cursor: pointer;
        }
        .weather-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent, #38bdf8);
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.1s ease;
        }
        .weather-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .weather-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent, #38bdf8);
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .console-box {
            background-color: var(--bg-console);
            height: 450px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .console-box::-webkit-scrollbar { width: 6px; }
        .console-box::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        .console-box::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
        .sidebar-btn { transition: all 0.15s ease; }
        .sidebar-btn:hover { transform: translateX(4px); background-color: var(--bg-card-hover); }
        .sidebar-btn.active { background-color: var(--bg-card-hover); border-left: 3px solid var(--accent); color: var(--accent); }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .fade-in { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease forwards; }
        .player-card:hover { background-color: var(--bg-card-hover); }

        .t-header { background-color: var(--bg-header); border-color: var(--border-header); backdrop-filter: blur(12px); }
        .t-sidebar { background-color: var(--bg-sidebar); border-color: var(--border-color); }
        .t-card { background-color: var(--bg-card); border-color: var(--border-color); transition: all 0.2s ease; }
        .t-card:hover { border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }
        .t-accent { color: var(--accent); }
        .t-input { background-color: var(--bg-input); border-color: var(--border-color); }
        .t-input:focus { border-color: var(--accent); }
        .t-muted { color: var(--text-muted); }
        .t-dim { color: var(--text-dim); }
        .theme-dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; }
        .theme-dot:hover { transform: scale(1.2); }
        .theme-dot.active { border-color: white; box-shadow: 0 0 8px rgba(255,255,255,0.3); }
        .theme-picker { position: relative; }
        .theme-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; padding: 12px; border-radius: 12px; background: var(--bg-card); border: 1px solid var(--border-color); backdrop-filter: blur(12px); z-index: 100; min-width: 200px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .theme-dropdown.show { display: block; animation: fadeIn 0.15s ease; }
        .overview-card { position: relative; overflow: hidden; }
        .overview-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), transparent); opacity: 0; transition: opacity 0.3s; }
        .overview-card:hover::before { opacity: 1; }
        .card-emoji { font-size: 1.75rem; line-height: 1; }
        .glow-text { text-shadow: 0 0 20px var(--accent-glow); }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="t-card rounded-2xl border p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold t-accent glow-text mb-2">üéÆ RCON Dashboard</h1>
                <p class="text-sm t-muted">Connect to your Rust server</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 uppercase tracking-wider mb-1 block">Server Host / IP</label>
                    <input type="text" id="login-host" class="w-full bg-slate-900 border border-slate-700 px-4 py-3 rounded-lg text-sm focus:outline-none focus:border-sky-500 transition console-font" placeholder="rust.example.com" autocomplete="off">
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase tracking-wider mb-1 block">RCON Port</label>
                    <input type="number" id="login-port" class="w-full bg-slate-900 border border-slate-700 px-4 py-3 rounded-lg text-sm focus:outline-none focus:border-sky-500 transition console-font" placeholder="28016" value="28016">
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase tracking-wider mb-1 block">RCON Password</label>
                    <input type="password" id="login-password" class="w-full bg-slate-900 border border-slate-700 px-4 py-3 rounded-lg text-sm focus:outline-none focus:border-sky-500 transition console-font" placeholder="Enter RCON password">
                </div>
                <div id="login-error" class="hidden text-sm text-red-400 bg-red-950/50 border border-red-800/30 rounded-lg px-4 py-2"></div>
                <button onclick="doLogin()" id="login-btn" class="w-full bg-sky-600 hover:bg-sky-500 py-3 rounded-lg text-sm font-semibold transition mt-2">Connect</button>
            </div>
            <!-- Saved Servers -->
            <div id="saved-servers-section" class="mt-6 pt-6 border-t border-slate-700/50" style="display:none;">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xs text-slate-400 uppercase tracking-wider">Saved Servers</h2>
                    <button onclick="clearAllSavedServers()" class="text-[10px] text-red-400/60 hover:text-red-400 transition">Clear All</button>
                </div>
                <div id="saved-servers-list" class="space-y-2 max-h-[200px] overflow-y-auto pr-1"></div>
            </div>
            </div>
        </div>
    </div>

    <!-- Dashboard (hidden until connected) -->
    <div id="dashboard" class="hidden">
    <!-- Top Bar -->
    <header class="t-header border-b px-6 py-3 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold t-accent tracking-tight glow-text">üéÆ RCON Dashboard</h1>
            <span id="server-addr" class="text-xs t-dim console-font">...</span>
        </div>
        <div class="flex items-center gap-4">
            <div id="status-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-900/50 border border-red-800/50 text-sm">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-red-500 pulse-dot"></span>
                <span id="status-text" class="text-red-300">Connecting...</span>
            </div>
            <button onclick="doReconnect()" class="text-xs t-muted hover:text-white transition">Reconnect</button>
            <button onclick="doDisconnect()" class="text-xs text-red-400 hover:text-red-300 transition">Disconnect</button>
            <!-- Theme Switcher -->
            <div class="theme-picker">
                <button onclick="toggleThemeDropdown()" class="text-xs t-muted hover:text-white transition flex items-center gap-1.5 px-2 py-1 rounded hover:bg-white/5" title="Change theme">
                    üé® Theme
                </button>
                <div id="theme-dropdown" class="theme-dropdown">
                    <p class="text-xs t-muted uppercase tracking-wider mb-3">Choose Theme</p>
                    <div class="grid grid-cols-1 gap-1.5">
                        <button onclick="setTheme('')" class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition text-left text-sm" data-theme-btn="">
                            <span class="theme-dot active" style="background: #38bdf8;"></span> Midnight Sky
                        </button>
                        <button onclick="setTheme('ocean')" class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition text-left text-sm" data-theme-btn="ocean">
                            <span class="theme-dot" style="background: #06b6d4;"></span> Deep Ocean
                        </button>
                        <button onclick="setTheme('emerald')" class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition text-left text-sm" data-theme-btn="emerald">
                            <span class="theme-dot" style="background: #34d399;"></span> Emerald Forest
                        </button>
                        <button onclick="setTheme('sunset')" class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition text-left text-sm" data-theme-btn="sunset">
                            <span class="theme-dot" style="background: #f472b6;"></span> Sunset Rose
                        </button>
                        <button onclick="setTheme('amber')" class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition text-left text-sm" data-theme-btn="amber">
                            <span class="theme-dot" style="background: #fbbf24;"></span> Golden Amber
                        </button>
                        <button onclick="setTheme('violet')" class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition text-left text-sm" data-theme-btn="violet">
                            <span class="theme-dot" style="background: #a78bfa;"></span> Neon Violet
                        </button>
                        <button onclick="setTheme('dark')" class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition text-left text-sm" data-theme-btn="dark">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #333 50%, #111 50%);"></span> Dark Mode
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex min-h-[calc(100vh-57px)]">
        <!-- Sidebar -->
        <nav class="w-56 t-sidebar border-r p-4 space-y-1">
            <button onclick="switchTab('overview')" data-tab="overview" class="sidebar-btn active w-full text-left px-4 py-2.5 rounded text-sm flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                Overview
            </button>
            <button onclick="switchTab('players')" data-tab="players" class="sidebar-btn w-full text-left px-4 py-2.5 rounded text-sm flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                Players <span id="player-count-badge" class="ml-auto text-xs bg-slate-700 px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="switchTab('console')" data-tab="console" class="sidebar-btn w-full text-left px-4 py-2.5 rounded text-sm flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Console
            </button>
            <button onclick="switchTab('inventory')" data-tab="inventory" class="sidebar-btn w-full text-left px-4 py-2.5 rounded text-sm flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Give Items
            </button>
            <button onclick="switchTab('plugins')" data-tab="plugins" class="sidebar-btn w-full text-left px-4 py-2.5 rounded text-sm flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"/></svg>
                Plugins <span id="plugin-count-badge" class="ml-auto text-xs bg-slate-700 px-2 py-0.5 rounded-full">0</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 p-6 overflow-y-auto">

            <!-- Overview Tab (merged with Server Stats) -->
            <div id="overview-tab" class="fade-in">
                <!-- Welcome Banner -->
                <div class="t-card rounded-xl p-5 border mb-6 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent" style="background: linear-gradient(135deg, var(--accent-glow), transparent 60%);"></div>
                    <div class="relative flex justify-between items-center">
                        <div>
                            <h3 class="text-base font-semibold mb-1">üëã Welcome back, Admin</h3>
                            <p class="text-sm t-muted">Here's a quick look at your Rust server status.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="stats-last-update" class="text-xs text-slate-500">Not updated yet</span>
                            <button onclick="rebootServer()" class="text-xs bg-red-700/60 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg transition font-medium">‚ü≥ Reboot</button>
                        </div>
                    </div>
                </div>

                <!-- Top KPI Cards with Sparklines -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="t-card rounded-xl p-4 border">
                        <p class="text-xs t-muted uppercase tracking-wider mb-1">üèÉ Server FPS</p>
                        <p id="stat-fps" class="text-2xl font-bold text-sky-400">--</p>
                        <div class="mt-2 h-12"><canvas id="fps-chart" width="200" height="48"></canvas></div>
                    </div>
                    <div class="t-card rounded-xl p-4 border">
                        <p class="text-xs t-muted uppercase tracking-wider mb-1">üß± Entities</p>
                        <p id="stat-entities" class="text-2xl font-bold text-amber-400">--</p>
                        <div class="mt-2 h-12"><canvas id="entity-chart" width="200" height="48"></canvas></div>
                    </div>
                    <div class="t-card rounded-xl p-4 border">
                        <p class="text-xs t-muted uppercase tracking-wider mb-1">üïê Game Time</p>
                        <p id="stat-gametime" class="text-2xl font-bold text-purple-400">--</p>
                        <p id="stat-daycycle" class="text-xs text-slate-500 mt-1"></p>
                    </div>
                    <div class="t-card rounded-xl p-4 border">
                        <p class="text-xs t-muted uppercase tracking-wider mb-1">üë• Players</p>
                        <p class="text-2xl font-bold text-green-400"><span id="stat-players">--</span></p>
                        <p id="stat-queue" class="text-xs text-slate-500 mt-1"></p>
                    </div>
                </div>

                <!-- Connection Status Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="t-card rounded-xl p-4 border">
                        <p class="text-xs t-muted uppercase tracking-wider mb-1">üîó Connection</p>
                        <p id="overview-connection" class="text-lg font-bold text-red-400">Connecting...</p>
                    </div>
                    <div class="t-card rounded-xl p-4 border">
                        <p class="text-xs t-muted uppercase tracking-wider mb-1">üë• Players Online</p>
                        <p id="overview-players" class="text-lg font-bold">0</p>
                    </div>
                    <div class="t-card rounded-xl p-4 border">
                        <p class="text-xs t-muted uppercase tracking-wider mb-1">üñ•Ô∏è Server</p>
                        <p id="overview-server" class="text-lg font-semibold truncate" style="color: var(--text-primary);">...</p>
                    </div>
                </div>


                <!-- Detail Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Performance -->
                    <div class="t-card rounded-xl p-5 border">
                        <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            Performance
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="t-muted">Framerate</span><span id="perf-fps" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Memory</span><span id="perf-memory" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Collections</span><span id="perf-collections" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Uptime</span><span id="perf-uptime" class="console-font">--</span></div>
                        </div>
                    </div>

                    <!-- Network -->
                    <div class="t-card rounded-xl p-5 border">
                        <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.858 15.355-5.858 21.213 0"/></svg>
                            Network
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="t-muted">Network In</span><span id="net-in" class="console-font text-green-300">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Network Out</span><span id="net-out" class="console-font text-amber-300">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Players Online</span><span id="net-players" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Queued</span><span id="net-queued" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Joining</span><span id="net-joining" class="console-font">--</span></div>
                        </div>
                    </div>

                    <!-- World -->
                    <div class="t-card rounded-xl p-5 border">
                        <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            World
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="t-muted">Map</span><span id="world-map" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">World Size</span><span id="world-size" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Seed</span><span id="world-seed" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Entity Count</span><span id="world-entities" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Save Created</span><span id="world-save" class="console-font">--</span></div>
                        </div>
                    </div>

                    <!-- Server Identity -->
                    <div class="t-card rounded-xl p-5 border">
                        <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
                            Server Info
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between gap-4"><span class="t-muted shrink-0">Server Name</span><span id="srv-hostname" class="console-font text-right break-all">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Hostname</span><span id="srv-dns" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">IP Address</span><span id="srv-ip" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Players</span><span id="srv-maxplayers" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Restarting</span><span id="srv-restarting" class="console-font">--</span></div>
                            <div class="flex justify-between"><span class="t-muted">Protocol</span><span id="srv-protocol" class="console-font">--</span></div>
                        </div>
                    </div>
                </div>

                <!-- Weather Convars -->
                <div class="t-card rounded-xl p-5 border mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-semibold flex items-center gap-2">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>
                            Weather Convars
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="resetWeather()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition" title="Reset all to 0">Reset</button>
                            <button onclick="fetchWeatherConvars()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition">Refresh</button>
                        </div>
                    </div>
                    <!-- Toggles -->
                    <div class="grid grid-cols-5 gap-4 mb-5" id="weather-toggles">
                        <div class="flex flex-col items-center gap-2 bg-slate-800/50 rounded-lg py-3 px-2 border border-slate-700/30">
                            <span class="text-sm font-medium t-muted">Fog</span>
                            <button id="weather-fog-toggle" onclick="toggleWeather('fog')" class="relative w-12 h-6 rounded-full bg-slate-700 transition-colors cursor-pointer">
                                <span id="weather-fog-dot" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-all"></span>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-2 bg-slate-800/50 rounded-lg py-3 px-2 border border-slate-700/30">
                            <span class="text-sm font-medium t-muted">Rain</span>
                            <button id="weather-rain-toggle" onclick="toggleWeather('rain')" class="relative w-12 h-6 rounded-full bg-slate-700 transition-colors cursor-pointer">
                                <span id="weather-rain-dot" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-all"></span>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-2 bg-slate-800/50 rounded-lg py-3 px-2 border border-slate-700/30">
                            <span class="text-sm font-medium t-muted">Clouds</span>
                            <button id="weather-clouds-toggle" onclick="toggleWeather('clouds')" class="relative w-12 h-6 rounded-full bg-slate-700 transition-colors cursor-pointer">
                                <span id="weather-clouds-dot" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-all"></span>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-2 bg-slate-800/50 rounded-lg py-3 px-2 border border-slate-700/30">
                            <span class="text-sm font-medium t-muted">Wind</span>
                            <button id="weather-wind-toggle" onclick="toggleWeather('wind')" class="relative w-12 h-6 rounded-full bg-slate-700 transition-colors cursor-pointer">
                                <span id="weather-wind-dot" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-all"></span>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-2 bg-slate-800/50 rounded-lg py-3 px-2 border border-slate-700/30">
                            <span class="text-sm font-medium t-muted">Thunder</span>
                            <button id="weather-thunder-toggle" onclick="toggleWeather('thunder')" class="relative w-12 h-6 rounded-full bg-slate-700 transition-colors cursor-pointer">
                                <span id="weather-thunder-dot" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-all"></span>
                            </button>
                        </div>
                    </div>
                    <!-- Sliders -->
                    <div id="weather-controls">
                        <div class="weather-slider-row">
                            <div class="flex justify-between text-sm mb-1"><span class="t-muted">Time</span><span id="weather-time-val" class="console-font text-orange-300">--</span></div>
                            <input type="range" min="0" max="24" step="0.5" value="12" id="weather-time" class="weather-slider w-full" oninput="setTimeConvar(this.value)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Players Tab -->
            <div id="players-tab" class="hidden fade-in">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            Players
                        </h2>
                        <div class="flex bg-slate-800/80 rounded-lg border border-slate-700/50 p-0.5">
                            <button onclick="switchPlayerView('online')" id="players-view-online" class="text-xs px-3 py-1.5 rounded-md transition font-medium bg-sky-600 text-white">Online</button>
                            <button onclick="switchPlayerView('sleeping')" id="players-view-sleeping" class="text-xs px-3 py-1.5 rounded-md transition font-medium text-slate-400 hover:text-white">
                                Sleeping <span id="sleeping-count-badge" class="ml-1 text-[10px] bg-purple-900/50 text-purple-400 px-1.5 py-0.5 rounded-full hidden">0</span>
                            </button>
                            <button onclick="switchPlayerView('banned')" id="players-view-banned" class="text-xs px-3 py-1.5 rounded-md transition font-medium text-slate-400 hover:text-white">
                                Banned <span id="ban-count-badge" class="ml-1 text-[10px] bg-red-900/50 text-red-400 px-1.5 py-0.5 rounded-full hidden">0</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshCurrentPlayerView()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Online Players View -->
                <div id="players-online-view">
                    <div class="flex gap-6">
                        <div id="player-list" class="space-y-2 flex-1 min-w-0">
                            <p class="text-slate-500 italic text-sm">Waiting for player data...</p>
                        </div>
                        <!-- Player Detail Panel -->
                        <div id="player-detail" class="hidden w-80 shrink-0">
                            <div class="t-card rounded-xl border p-5 sticky top-6">
                                <button onclick="closePlayerDetail()" class="absolute top-3 right-3 text-slate-500 hover:text-slate-300 text-lg">&times;</button>
                                <div class="flex flex-col items-center text-center mb-4">
                                    <img id="pd-avatar" src="" alt="" class="w-20 h-20 rounded-full bg-slate-700 mb-3 border-2 border-slate-600">
                                    <h3 id="pd-name" class="font-semibold text-base"></h3>
                                    <p id="pd-steamid" class="text-xs text-slate-500 console-font mt-0.5"></p>
                                </div>
                                <div class="space-y-2 text-sm mb-4">
                                    <div class="flex justify-between"><span class="t-muted">Ping</span><span id="pd-ping" class="console-font"></span></div>
                                    <div class="flex justify-between"><span class="t-muted">IP Address</span><span id="pd-ip" class="console-font"></span></div>
                                    <div class="flex justify-between"><span class="t-muted">Connected</span><span id="pd-connected" class="console-font"></span></div>
                                    <div class="flex justify-between"><span class="t-muted">Health</span><span id="pd-health" class="console-font"></span></div>
                                    <div class="flex justify-between"><span class="t-muted">Violations</span><span id="pd-violations" class="console-font"></span></div>
                                </div>
                                <div id="pd-extra" class="space-y-2 text-sm mb-4 border-t border-slate-700/50 pt-3"></div>
                                <div class="space-y-2">
                                    <a id="pd-steam-link" href="#" target="_blank" class="block w-full text-center bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-sm transition">View Steam Profile</a>
                                    <a id="pd-battlemetrics-link" href="#" target="_blank" class="block w-full text-center bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-sm transition">View on Battlemetrics</a>
                                    <div class="flex gap-2 mt-2">
                                        <button id="pd-kill-btn" class="flex-1 text-xs bg-orange-700/50 hover:bg-orange-600 px-2 py-2 rounded transition" title="Kill (bypasses god mode)">Kill</button>
                                        <button id="pd-mute-btn" class="flex-1 text-xs bg-purple-700/50 hover:bg-purple-600 px-2 py-2 rounded transition">Mute</button>
                                        <button id="pd-kick-btn" class="flex-1 text-xs bg-yellow-700/50 hover:bg-yellow-600 px-2 py-2 rounded transition">Kick</button>
                                        <button id="pd-ban-btn" class="flex-1 text-xs bg-red-700/50 hover:bg-red-600 px-2 py-2 rounded transition">Ban</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sleeping Players View -->
                <div id="players-sleeping-view" class="hidden">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="sleeping-search" class="flex-1 bg-slate-900 border border-slate-700 px-4 py-2.5 rounded-lg text-sm focus:outline-none focus:border-sky-500 transition" placeholder="Search sleeping players..." oninput="filterSleepingList()">
                    </div>
                    <div id="sleeping-list" class="space-y-2 max-h-[calc(100vh-230px)] overflow-y-auto pr-1 custom-scrollbar">
                        <p class="text-slate-500 italic text-sm text-center py-8">Click Refresh to load sleeping players</p>
                    </div>
                    <div id="sleeping-list-empty" class="hidden text-center py-12 t-muted">
                        <p class="text-lg mb-1">No sleeping players</p>
                        <p class="text-sm">There are no sleepers on the server</p>
                    </div>
                </div>

                <!-- Banned Players View -->
                <div id="players-banned-view" class="hidden">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="ban-search" class="flex-1 bg-slate-900 border border-slate-700 px-4 py-2.5 rounded-lg text-sm focus:outline-none focus:border-sky-500 transition" placeholder="Search banned players..." oninput="filterBanList()">
                    </div>
                    <div id="ban-list" class="space-y-2 max-h-[calc(100vh-230px)] overflow-y-auto pr-1 custom-scrollbar">
                        <p class="text-slate-500 italic text-sm text-center py-8">Click Refresh to load ban list</p>
                    </div>
                    <div id="ban-list-empty" class="hidden text-center py-12 t-muted">
                        <p class="text-lg mb-1">No banned players</p>
                        <p class="text-sm">The server ban list is empty</p>
                    </div>
                </div>
            </div>

            <!-- Console Tab -->
            <div id="console-tab" class="hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Console (2/3 width) -->
                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold flex items-center gap-2">
                                <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                Server Console
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="clearConsole()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition">Clear</button>
                                <button onclick="toggleAutoScroll()" id="autoscroll-btn" class="text-xs bg-sky-700 hover:bg-sky-600 px-3 py-1.5 rounded transition">Auto-scroll: ON</button>
                            </div>
                        </div>
                        <div id="console-output" class="console-box console-font p-4 rounded-lg border border-slate-800 text-xs leading-relaxed"></div>
                        <div class="flex gap-2 mt-3">
                            <span class="text-slate-500 self-center console-font text-sm">&gt;</span>
                            <input type="text" id="cmd-input"
                                class="flex-1 bg-slate-900 border border-slate-700 px-3 py-2.5 rounded console-font text-sm focus:outline-none focus:border-sky-500 transition"
                                placeholder="Type RCON command..." autocomplete="off" spellcheck="false">
                            <button onclick="sendFromInput()" class="bg-sky-600 px-5 py-2.5 rounded hover:bg-sky-500 text-sm font-medium transition">Send</button>
                        </div>
                        <div class="text-xs text-slate-600 mt-1 ml-5">Use Up/Down arrows for command history</div>
                    </div>
                    <!-- Chat Panel (1/3 width) -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                Chat
                            </h2>
                            <button onclick="clearChat()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition">Clear</button>
                        </div>
                        <div id="chat-output" class="console-box console-font p-4 rounded-lg border border-slate-800 text-xs leading-relaxed"></div>
                        <div class="flex gap-2 mt-3">
                            <input type="text" id="chat-input"
                                class="flex-1 bg-slate-900 border border-slate-700 px-3 py-2.5 rounded console-font text-sm focus:outline-none focus:border-sky-500 transition"
                                placeholder="Send server message..." autocomplete="off" spellcheck="false">
                            <button onclick="sendChatMessage()" class="bg-green-600 px-5 py-2.5 rounded hover:bg-green-500 text-sm font-medium transition">Say</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Give Tab -->
            <div id="inventory-tab" class="hidden fade-in">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    Give Items
                </h2>
                <div class="flex gap-6">
                    <!-- Give Form -->
                    <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700/50 w-96 shrink-0">
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-slate-400 uppercase tracking-wider mb-1 block">Player</label>
                                <select id="target-player" class="w-full bg-slate-900 border border-slate-700 px-3 py-2.5 rounded text-sm focus:outline-none focus:border-sky-500 appearance-none cursor-pointer">
                                    <option value="">Select a player...</option>
                                </select>
                            </div>
                            <div class="relative">
                                <label class="text-xs text-slate-400 uppercase tracking-wider mb-1 block">Item</label>
                                <input type="text" id="item-search" class="w-full bg-slate-900 border border-slate-700 px-3 py-2.5 rounded text-sm focus:outline-none focus:border-sky-500" placeholder="Search items..." autocomplete="off">
                                <input type="hidden" id="item-id">
                                <div id="item-dropdown" class="hidden absolute z-50 left-0 right-0 top-full mt-1 bg-slate-900 border border-slate-700 rounded-lg max-h-64 overflow-y-auto shadow-xl"></div>
                                <div id="item-selected" class="hidden mt-2 flex items-center gap-2 bg-slate-900/80 border border-slate-700/50 rounded px-3 py-2 text-xs">
                                    <div class="flex-1">
                                        <span id="item-sel-name" class="text-slate-200 font-medium"></span>
                                        <span id="item-sel-short" class="text-slate-500 ml-2"></span>
                                    </div>
                                    <span id="item-sel-stack" class="text-slate-600"></span>
                                    <button onclick="clearItemSelection()" class="text-slate-500 hover:text-red-400 ml-1">&times;</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 uppercase tracking-wider mb-1 block">Amount</label>
                                <input type="number" id="item-amount" class="w-full bg-slate-900 border border-slate-700 px-3 py-2.5 rounded text-sm focus:outline-none focus:border-sky-500" value="1" min="1">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="addToQueue()" class="flex-1 bg-sky-600 py-2.5 rounded hover:bg-sky-500 text-sm font-medium transition">+ Add to Queue</button>
                                <button onclick="giveItem()" class="flex-1 bg-green-600 py-2.5 rounded hover:bg-green-500 text-sm font-medium transition">Give Now</button>
                            </div>
                        </div>

                        <!-- Item Queue -->
                        <div id="item-queue-section" class="mt-5 hidden">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-slate-400 uppercase tracking-wider">Queued Items</span>
                                <button onclick="clearQueue()" class="text-xs text-red-400 hover:text-red-300 transition">Clear All</button>
                            </div>
                            <div id="item-queue-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar"></div>
                            <button onclick="sendQueue()" class="w-full mt-3 bg-green-600 py-2.5 rounded hover:bg-green-500 text-sm font-medium transition flex items-center justify-center gap-2">
                                <span>Send All</span>
                                <span id="queue-count-badge" class="bg-green-800 text-green-200 text-xs px-2 py-0.5 rounded-full">0</span>
                            </button>
                        </div>
                    </div>
                    <!-- Item Browser -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-3">
                            <input type="text" id="item-browser-search" class="flex-1 bg-slate-900 border border-slate-700 px-3 py-2 rounded text-sm focus:outline-none focus:border-sky-500" placeholder="Browse all items...">
                            <span id="item-browser-count" class="text-xs text-slate-500 whitespace-nowrap">0 items</span>
                        </div>
                        <div id="item-browser-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-[520px] overflow-y-auto pr-1 custom-scrollbar"></div>
                    </div>
                </div>
            </div>

            <!-- Plugins Tab -->
            <div id="plugins-tab" class="hidden fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"/></svg>
                        Plugins
                    </h2>
                    <div class="flex items-center gap-3">
                        <span id="plugin-framework" class="text-xs px-2.5 py-1 rounded-full bg-slate-700/60 border border-slate-600/40">Detecting...</span>
                        <button onclick="refreshPlugins()" class="text-xs t-muted hover:text-white transition flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800/60 border border-slate-700/40 hover:border-sky-500/40">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Refresh
                        </button>
                    </div>
                </div>
                <!-- Failed Plugins -->
                <div id="plugins-failed-section" class="hidden mb-4">
                    <div class="bg-red-950/40 border border-red-800/30 rounded-lg p-4">
                        <h3 class="text-sm font-semibold text-red-400 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                            Failed to Load
                        </h3>
                        <div id="plugins-failed-list" class="space-y-1.5"></div>
                    </div>
                </div>
                <!-- Raw Output Debug -->
                <div id="plugins-raw-section" class="hidden mb-4">
                    <div class="bg-slate-900/80 border border-slate-700/50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xs font-semibold t-muted uppercase tracking-wide">Raw Server Response</h3>
                            <button onclick="document.getElementById('plugins-raw-section').classList.add('hidden')" class="text-xs t-muted hover:text-white">&times; Close</button>
                        </div>
                        <pre id="plugins-raw-output" class="text-xs console-font text-slate-300 whitespace-pre-wrap break-all max-h-64 overflow-y-auto custom-scrollbar bg-black/30 rounded p-3"></pre>
                    </div>
                </div>
                <!-- Search -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="plugin-search" class="flex-1 bg-slate-900 border border-slate-700 px-4 py-2.5 rounded-lg text-sm focus:outline-none focus:border-sky-500 transition" placeholder="Search plugins..." oninput="filterPlugins()">
                    <button onclick="togglePluginRaw()" class="text-xs px-3 py-2 rounded-lg bg-slate-800/60 border border-slate-700/40 t-muted hover:text-white hover:border-slate-600 transition">Raw</button>
                </div>
                <!-- Plugin Grid -->
                <div id="plugins-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 max-h-[calc(100vh-250px)] overflow-y-auto pr-1 custom-scrollbar"></div>
                <div id="plugins-empty" class="hidden text-center py-12 t-muted">
                    <p class="text-lg mb-1">No plugins found</p>
                    <p class="text-sm">Make sure your server has Carbon or Oxide installed</p>
                </div>
            </div>

            <!-- Toast Container -->
            <div id="toast-container" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-2"></div>
        </main>
    </div>
    </div><!-- end #dashboard -->

    <script>
        // ==========================================
        // Direct RCON WebSocket connection
        // (same approach as the reference webrcon project)
        // ==========================================

        var socket = null;
        var serverAddr = '';
        var rconHost = '';
        var rconPort = '';
        var rconPassword = '';
        var autoScroll = true;
        var cmdHistory = [];
        var cmdHistoryIndex = -1;
        var currentPlayers = [];
        var mutedPlayers = {};
        var callbacks = {};
        var lastIdentifier = 1001;
        var consoleOutput = document.getElementById('console-output');

        // ========== LOGIN ==========
        function getSavedServers() {
            try { return JSON.parse(localStorage.getItem('rcon_saved_servers') || '[]'); } catch(e) { return []; }
        }
        function saveSavedServers(list) {
            localStorage.setItem('rcon_saved_servers', JSON.stringify(list));
        }
        function renderSavedServers() {
            var servers = getSavedServers();
            var section = document.getElementById('saved-servers-section');
            var list = document.getElementById('saved-servers-list');
            if (!servers.length) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            list.innerHTML = '';
            servers.forEach(function(s, i) {
                var el = document.createElement('div');
                el.className = 'flex items-center gap-2 group';
                el.innerHTML = '<button onclick="loadSavedServer(' + i + ')" class="flex-1 flex items-center gap-3 px-3 py-2.5 rounded-lg bg-slate-800/60 border border-slate-700/40 hover:border-sky-500/50 hover:bg-slate-800 transition text-left">' +
                    '<span class="text-base">\uD83D\uDDA5\uFE0F</span>' +
                    '<div class="min-w-0 flex-1">' +
                    '<div class="text-sm font-medium truncate" style="color:var(--text-primary)">' + escapeHtml(s.label || s.host) + '</div>' +
                    '<div class="text-[11px]" style="color:var(--text-muted)">' + escapeHtml(s.host) + ':' + escapeHtml(s.port) + ' &bull; ' + (s.password ? '\uD83D\uDD12 saved' : '\uD83D\uDD13 no password') + '</div>' +
                    '</div></button>' +
                    '<button onclick="deleteSavedServer(' + i + ')" class="opacity-0 group-hover:opacity-100 p-1.5 rounded hover:bg-red-900/30 text-red-400/60 hover:text-red-400 transition" title="Remove">\u2715</button>';
                list.appendChild(el);
            });
        }
        function escapeHtml(str) {
            var d = document.createElement('div'); d.textContent = str; return d.innerHTML;
        }
        function loadSavedServer(idx) {
            var servers = getSavedServers();
            var s = servers[idx];
            if (!s) return;
            document.getElementById('login-host').value = s.host || '';
            document.getElementById('login-port').value = s.port || '28016';
            document.getElementById('login-password').value = s.password || '';
            doLogin();
        }
        function deleteSavedServer(idx) {
            var servers = getSavedServers();
            servers.splice(idx, 1);
            saveSavedServers(servers);
            renderSavedServers();
        }
        function clearAllSavedServers() {
            saveSavedServers([]);
            renderSavedServers();
        }
        function saveCurrentServer(host, port, password, label) {
            var servers = getSavedServers();
            var existing = -1;
            for (var i = 0; i < servers.length; i++) {
                if (servers[i].host === host && servers[i].port === port) { existing = i; break; }
            }
            var entry = { host: host, port: port, password: password, label: label || host };
            if (existing >= 0) {
                servers[existing] = entry;
            } else {
                servers.unshift(entry);
            }
            if (servers.length > 10) servers = servers.slice(0, 10);
            saveSavedServers(servers);
        }

        // Migrate old single-server save & init
        (function() {
            var old = localStorage.getItem('rcon_server');
            if (old) {
                try {
                    var s = JSON.parse(old);
                    if (s.host) {
                        var servers = getSavedServers();
                        var exists = servers.some(function(sv) { return sv.host === s.host && sv.port === s.port; });
                        if (!exists) servers.unshift({ host: s.host, port: s.port, password: '', label: s.host });
                        saveSavedServers(servers);
                    }
                } catch(e) {}
                localStorage.removeItem('rcon_server');
            }
            renderSavedServers();
            ['login-host', 'login-port', 'login-password'].forEach(function(id) {
                document.getElementById(id).addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') doLogin();
                });
            });
        })();

        function doLogin() {
            var host = document.getElementById('login-host').value.trim();
            var port = document.getElementById('login-port').value.trim();
            var password = document.getElementById('login-password').value;
            var errEl = document.getElementById('login-error');
            errEl.classList.add('hidden');

            if (!host) { showLoginError('Server host is required'); return; }
            if (!port) { showLoginError('RCON port is required'); return; }
            if (!password) { showLoginError('RCON password is required'); return; }

            // Save to known servers list
            saveCurrentServer(host, port, password, host);

            // Store credentials in memory
            rconHost = host;
            rconPort = port;
            rconPassword = password;
            serverAddr = host + ':' + port;

            // Update UI
            document.getElementById('server-addr').textContent = serverAddr;
            document.getElementById('overview-server').textContent = serverAddr;

            // Disable button while connecting
            var btn = document.getElementById('login-btn');
            btn.textContent = 'Connecting...';
            btn.disabled = true;

            connectRcon(host, port, password);
        }

        function showLoginError(msg) {
            var errEl = document.getElementById('login-error');
            errEl.textContent = msg;
            errEl.classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function showLoginScreen() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            var btn = document.getElementById('login-btn');
            btn.textContent = 'Connect';
            btn.disabled = false;
            renderSavedServers();
        }

        // Fetch credentials from backend and auto-connect
        function init() {
            // init is called after login now ‚Äî connection happens from doLogin
        }

        // Connect directly to Rust RCON via browser WebSocket
        function connectRcon(host, port, password) {
            if (socket) {
                try { socket.close(); } catch(e) {}
            }

            var url = 'ws://' + host + ':' + port + '/' + password;
            appendConsole('Connecting to ' + host + ':' + port + '...', 'text-yellow-400');

            socket = new WebSocket(url);

            socket.onopen = function() {
                updateConnectionStatus(true);
                appendConsole('Connected to RCON', 'text-green-400');
                showDashboard();

                // Fetch console history
                setTimeout(function() {
                    sendRequest('console.tail 512', function(data) {
                        var msg = (data.Message || '').trim();
                        try {
                            var lines = JSON.parse(msg);
                            if (Array.isArray(lines)) {
                                lines.forEach(function(line) {
                                    handleRconMessage(line);
                                    // Track max time for dedup with poller
                                    if ((line.Time || 0) > lastTailTime) lastTailTime = line.Time;
                                });
                            }
                        } catch(e) {}
                    });
                    // Request initial data via targeted requests (won't pollute console)
                    refreshServerInfoSilent();
                    sendRequest('playerlist', function(data) {
                        var msg = (data.Message || '').trim();
                        try {
                            var parsed = JSON.parse(msg);
                            if (Array.isArray(parsed)) updatePlayerList(parsed);
                        } catch(e) {}
                    });
                    fetchWorldInfo();
                    fetchServerIP();
                    fetchWeatherConvars();
                }, 500);
            };

            socket.onmessage = function(e) {
                var data;
                try {
                    data = JSON.parse(e.data);
                } catch(err) {
                    appendConsole(e.data, 'text-slate-400');
                    return;
                }

                // Check if this is a targeted response (identifier > 1000)
                if (data.Identifier > 1000 && callbacks[data.Identifier]) {
                    var cbMsg = (data.Message || '').trim();
                    // Skip plugin noise (e.g. Discord Logger "RCON command ... is run from")
                    if (cbMsg.indexOf('RCON command') !== -1 && cbMsg.indexOf('is run from') !== -1) {
                        // Don't delete callback ‚Äî still waiting for real response
                        return;
                    }
                    callbacks[data.Identifier](data);
                    delete callbacks[data.Identifier];
                    return;
                }

                // Generic message - handle it
                handleRconMessage(data);
            };

            socket.onclose = function(e) {
                updateConnectionStatus(false);
                // Only auto-reconnect if dashboard is visible (not on login screen / manual disconnect)
                if (!document.getElementById('dashboard').classList.contains('hidden')) {
                    appendConsole('Disconnected (code: ' + e.code + '). Reconnecting in 5s...', 'text-red-400');
                    setTimeout(function() {
                        if (rconHost && rconPort && rconPassword && !document.getElementById('dashboard').classList.contains('hidden')) {
                            connectRcon(rconHost, rconPort, rconPassword);
                        }
                    }, 5000);
                }
            };

            socket.onerror = function(err) {
                appendConsole('WebSocket error', 'text-red-400');
                updateConnectionStatus(false);
                var btn = document.getElementById('login-btn');
                btn.textContent = 'Connect';
                btn.disabled = false;
                showLoginError('Connection failed ‚Äî check host, port, and password');
            };
        }

        function handleRconMessage(data) {
            var msg = data.Message || '';
            var type = data.Type || '';

            // Skip RCON echo messages (like the reference project)
            if (msg.indexOf('[rcon]') === 0 || msg.indexOf('[rcon] ') === 0) {
                return;
            }

            // Skip Discord Logger plugin noise
            if (msg.indexOf('[Discord Logger]') !== -1) {
                return;
            }

            // Silently handle JSON data (serverinfo, playerlist) that comes via broadcast
            if (msg && msg.charAt(0) === '{' || msg.charAt(0) === '[') {
                try {
                    var parsed = JSON.parse(msg);
                    if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].SteamID) {
                        updatePlayerList(parsed);
                        return;
                    }
                    if (Array.isArray(parsed) && parsed.length === 0) {
                        updatePlayerList([]);
                        return;
                    }
                    if (parsed && typeof parsed === 'object' && parsed.Framerate !== undefined && parsed.EntityCount !== undefined) {
                        lastServerInfo = parsed;
                        updateStatsUI(parsed);
                        updateOverviewFromInfo(parsed);
                        return;
                    }
                } catch(e) {}
            }

            // Color by message type (matching reference project: Generic, Log, Error, Warning all display)
            var colorClass = 'text-slate-300';
            if (type === 'Error') colorClass = 'text-red-400';
            else if (type === 'Warning') colorClass = 'text-yellow-400';
            else if (type === 'Chat') colorClass = 'text-green-400';
            else if (type === 'Log') colorClass = 'text-slate-400';

            // Append chat messages to the chat panel
            if (type === 'Chat' && msg) {
                appendChat(msg);
            }

            if (msg) appendConsole(msg, colorClass);
        }

        // ========== CONNECTION STATUS ==========
        function updateConnectionStatus(connected) {
            var dot = document.getElementById('status-dot');
            var text = document.getElementById('status-text');
            var badge = document.getElementById('status-badge');
            var overview = document.getElementById('overview-connection');

            if (connected) {
                dot.className = 'w-2 h-2 rounded-full bg-green-500';
                text.textContent = 'Connected';
                text.className = 'text-green-300';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-900/50 border border-green-800/50 text-sm';
                overview.textContent = 'Connected';
                overview.className = 'text-lg font-semibold text-green-400';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-red-500 pulse-dot';
                text.textContent = 'Disconnected';
                text.className = 'text-red-300';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-900/50 border border-red-800/50 text-sm';
                overview.textContent = 'Disconnected';
                overview.className = 'text-lg font-semibold text-red-400';
            }
        }

        // ========== SEND COMMANDS ==========
        function sendCmd(command) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                appendConsole('Error: Not connected to RCON', 'text-red-400');
                return;
            }

            var packet = {
                Identifier: -1,
                Message: command,
                Name: "WebRcon"
            };
            socket.send(JSON.stringify(packet));
        }

        function rebootServer() {
            if (confirm('Are you sure you want to reboot the server?')) {
                sendCmd('restart 1');
                appendConsole('Server reboot initiated (restart 1)', 'text-red-400');
                showToast('Server reboot initiated', 'success');
            }
        }

        // Send command with callback (like rconService.Request in the reference project)
        function sendRequest(command, callback) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;

            lastIdentifier++;
            callbacks[lastIdentifier] = callback;

            var packet = {
                Identifier: lastIdentifier,
                Message: command,
                Name: "WebRcon"
            };
            socket.send(JSON.stringify(packet));
        }

        function sendFromInput() {
            var input = document.getElementById('cmd-input');
            var cmd = input.value.trim();
            if (!cmd) return;

            appendConsole('> ' + cmd, 'text-sky-400');
            sendCmd(cmd);

            if (cmdHistory[cmdHistory.length - 1] !== cmd) {
                cmdHistory.push(cmd);
            }
            cmdHistoryIndex = cmdHistory.length;
            input.value = '';
        }

        // ========== CONSOLE ==========
        function appendConsole(msg, colorClass) {
            colorClass = colorClass || 'text-slate-300';
            var div = document.createElement('div');
            div.className = 'py-0.5 ' + colorClass;
            var time = new Date().toLocaleTimeString('en-US', { hour12: false });
            div.innerHTML = '<span class="text-slate-600 mr-2">[' + time + ']</span>' + escapeHtml(msg);
            consoleOutput.appendChild(div);

            while (consoleOutput.children.length > 500) {
                consoleOutput.removeChild(consoleOutput.firstChild);
            }

            if (autoScroll) {
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }

        function clearConsole() { consoleOutput.innerHTML = ''; }

        var chatOutput = document.getElementById('chat-output');

        function appendChat(msg) {
            var username = '';
            var chatMsg = msg;
            try {
                var parsed = JSON.parse(msg);
                if (parsed && parsed.Username && parsed.Message !== undefined) {
                    username = parsed.Username;
                    chatMsg = parsed.Message;
                }
            } catch(e) {}
            var div = document.createElement('div');
            div.className = 'py-0.5 text-green-300';
            var time = new Date().toLocaleTimeString('en-US', { hour12: false });
            var html = '<span class="text-slate-600 mr-2">[' + time + ']</span>';
            if (username) {
                html += '<span class="text-sky-400 font-medium">' + escapeHtml(username) + ':</span> ' + escapeHtml(chatMsg);
            } else {
                html += escapeHtml(chatMsg);
            }
            div.innerHTML = html;
            chatOutput.appendChild(div);
            while (chatOutput.children.length > 200) {
                chatOutput.removeChild(chatOutput.firstChild);
            }
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        function clearChat() { chatOutput.innerHTML = ''; }

        function sendChatMessage() {
            var input = document.getElementById('chat-input');
            var msg = input.value.trim();
            if (!msg) return;
            sendRequest('say ' + msg, function() {});
            input.value = '';
        }

        // Chat input enter key
        document.getElementById('chat-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendChatMessage();
        });

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            var btn = document.getElementById('autoscroll-btn');
            btn.textContent = 'Auto-scroll: ' + (autoScroll ? 'ON' : 'OFF');
            btn.className = 'text-xs ' + (autoScroll ? 'bg-sky-700 hover:bg-sky-600' : 'bg-slate-700 hover:bg-slate-600') + ' px-3 py-1.5 rounded transition';
        }

        // ========== PLAYERS ==========
        function updatePlayerList(players) {
            currentPlayers = players;
            var count = players.length;
            document.getElementById('player-count-badge').textContent = count;
            document.getElementById('overview-players').textContent = count;

            // Update player dropdown on Give Items tab
            var sel = document.getElementById('target-player');
            var prev = sel.value;
            sel.innerHTML = '<option value="">Select a player...</option>' +
                players.map(function(p) {
                    var name = p.DisplayName || 'Unknown';
                    return '<option value="' + (p.SteamID || '') + '">' + escapeHtml(name) + ' (' + (p.SteamID || '') + ')</option>';
                }).join('');
            if (prev) sel.value = prev;

            var list = document.getElementById('player-list');
            if (count === 0) {
                list.innerHTML = '<p class="text-slate-500 italic text-sm">No players online.</p>';
                return;
            }

            list.innerHTML = players.map(function(p, idx) {
                var name = escapeHtml(p.DisplayName || 'Unknown');
                var steamId = p.SteamID || '';
                var ping = p.Ping || 0;
                var pingColor = ping < 100 ? 'text-green-500' : (ping < 200 ? 'text-yellow-500' : 'text-red-500');
                var ip = p.Address ? p.Address.split(':')[0] : '';
                var initial = (p.DisplayName || '?')[0].toUpperCase();
                var avatarUrl = steamAvatarCache[steamId] || 'https://avatars.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_medium.jpg';

                return '<div class="player-card flex justify-between items-center bg-slate-800/50 border border-slate-700/30 p-3 rounded-lg transition cursor-pointer hover:bg-slate-700/50" onclick="showPlayerDetail(' + idx + ')">' +
                    '<div class="flex items-center gap-3">' +
                        '<img src="' + avatarUrl + '" data-steamid="' + steamId + '" class="player-avatar w-8 h-8 rounded-full bg-slate-700" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'">' +
                        '<div class="w-8 h-8 rounded-full bg-slate-700 items-center justify-center text-xs font-bold text-sky-400" style="display:none">' + initial + '</div>' +
                        '<div>' +
                            '<span class="font-medium text-sm">' + name + '</span>' +
                            '<div class="text-xs text-slate-500 console-font">' + steamId + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="flex items-center gap-3">' +
                        '<span class="text-xs ' + pingColor + ' console-font">' + ping + 'ms</span>' +
                        '<span class="text-xs text-slate-500">' + ip + '</span>' +
                        '<div class="flex gap-1" onclick="event.stopPropagation()">' +
                            '<button onclick="killPlayer(' + idx + ')" class="text-xs bg-orange-700/50 hover:bg-orange-600 px-2 py-1 rounded transition">Kill</button>' +
                            '<button id="mute-btn-' + steamId + '" onclick="toggleMutePlayer(' + idx + ')" class="text-xs ' + (mutedPlayers[steamId] ? 'bg-purple-500/70 hover:bg-purple-400' : 'bg-purple-700/50 hover:bg-purple-600') + ' px-2 py-1 rounded transition">' + (mutedPlayers[steamId] ? 'Unmute' : 'Mute') + '</button>' +
                            '<button onclick="kickPlayer(' + idx + ')" class="text-xs bg-yellow-700/50 hover:bg-yellow-600 px-2 py-1 rounded transition">Kick</button>' +
                            '<button onclick="banPlayer(' + idx + ')" class="text-xs bg-red-700/50 hover:bg-red-600 px-2 py-1 rounded transition">Ban</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');

            // Load Steam avatars
            loadSteamAvatars(players);
        }

        function killPlayer(idx) {
            var p = currentPlayers[idx];
            if (!p) return;
            var name = p.DisplayName || p.SteamID;
            sendCmd('killplayer "' + name + '"');
            appendConsole('Killed ' + name, 'text-orange-400');
            showToast('Killed ' + name, 'success');
        }

        function toggleMutePlayer(idx) {
            var p = currentPlayers[idx];
            if (!p) return;
            var steamId = p.SteamID;
            var name = p.DisplayName || steamId;
            if (mutedPlayers[steamId]) {
                sendCmd('unmute "' + steamId + '"');
                delete mutedPlayers[steamId];
                appendConsole('Unmuted ' + name, 'text-purple-400');
                showToast('Unmuted ' + name, 'success');
            } else {
                sendCmd('mute "' + steamId + '"');
                mutedPlayers[steamId] = true;
                appendConsole('Muted ' + name, 'text-purple-400');
                showToast('Muted ' + name, 'success');
            }
            if (currentPlayers.length) updatePlayerList(currentPlayers);
            var pdMuteBtn = document.getElementById('pd-mute-btn');
            if (pdMuteBtn) {
                pdMuteBtn.textContent = mutedPlayers[steamId] ? 'Unmute' : 'Mute';
                pdMuteBtn.className = 'flex-1 text-xs px-2 py-2 rounded transition ' + (mutedPlayers[steamId] ? 'bg-purple-500/70 hover:bg-purple-400' : 'bg-purple-700/50 hover:bg-purple-600');
            }
        }

        function kickPlayer(idx) {
            var p = currentPlayers[idx];
            if (!p) return;
            var steamId = p.SteamID;
            sendCmd('kick "' + steamId + '" "Kicked by admin"');
            appendConsole('Kicked ' + steamId, 'text-yellow-400');
            showToast('Kicked player ' + steamId, 'success');
        }

        function banPlayer(idx) {
            var p = currentPlayers[idx];
            if (!p) return;
            var steamId = p.SteamID;
            var name = p.DisplayName || steamId;
            if (confirm('Ban ' + name + '?')) {
                sendCmd('ban "' + steamId + '" "Banned by admin"');
                appendConsole('Banned ' + steamId, 'text-red-400');
                showToast('Banned ' + name, 'success');
            }
        }

        // ========== BANNED PLAYERS ==========
        var currentPlayerView = 'online';
        var bannedPlayers = [];
        var banListLoaded = false;

        function switchPlayerView(view) {
            currentPlayerView = view;
            var views = ['online', 'sleeping', 'banned'];
            var activeColors = { online: 'bg-sky-600', sleeping: 'bg-purple-600', banned: 'bg-red-600' };
            var inactiveClass = 'text-xs px-3 py-1.5 rounded-md transition font-medium text-slate-400 hover:text-white';

            views.forEach(function(v) {
                var viewEl = document.getElementById('players-' + v + '-view');
                var btnEl = document.getElementById('players-view-' + v);
                if (v === view) {
                    viewEl.classList.remove('hidden');
                    btnEl.className = 'text-xs px-3 py-1.5 rounded-md transition font-medium ' + activeColors[v] + ' text-white';
                } else {
                    viewEl.classList.add('hidden');
                    btnEl.className = inactiveClass;
                }
            });

            if (view === 'banned' && !banListLoaded) refreshBanList();
            if (view === 'sleeping' && !sleepingListLoaded) refreshSleepingList();
        }

        function refreshCurrentPlayerView() {
            if (currentPlayerView === 'online') {
                sendCmd('playerlist');
            } else if (currentPlayerView === 'sleeping') {
                refreshSleepingList();
            } else {
                refreshBanList();
            }
        }

        // ========== SLEEPING PLAYERS ==========
        var sleepingPlayers = [];
        var sleepingListLoaded = false;

        function refreshSleepingList() {
            var listEl = document.getElementById('sleeping-list');
            listEl.innerHTML = '<p class="text-slate-500 italic text-sm text-center py-8">Loading sleeping players...</p>';
            sendRequest('global.sleepingusers', function(data) {
                var msg = data.Message || '';
                console.log('[Sleeping] global.sleepingusers raw response:', msg.substring(0, 500));
                parseSleepingList(msg);
            });
        }

        function parseSleepingList(raw) {
            sleepingPlayers = [];

            if (!raw || !raw.trim()) {
                sleepingListLoaded = true;
                document.getElementById('sleeping-count-badge').classList.add('hidden');
                renderSleepingList();
                return;
            }

            var text = raw.replace(/\\n/g, '\n').replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            // Format: "SteamID:Name SteamID:Name ... N sleeping users"
            // All on one line, names can contain spaces
            // Split by finding all SteamID:Name pairs using regex
            // Each entry starts with a 17-digit SteamID followed by colon
            var pattern = /(\d{17}):([^]*?)(?=\s\d{17}:|\s*\d+\s+sleeping\s+users|$)/g;
            var match;
            while ((match = pattern.exec(text)) !== null) {
                var steamId = match[1];
                var name = match[2].trim();
                if (steamId && name) {
                    sleepingPlayers.push({
                        steamId: steamId,
                        name: name,
                        raw: steamId + ':' + name
                    });
                }
            }

            sleepingListLoaded = true;
            var badge = document.getElementById('sleeping-count-badge');
            if (sleepingPlayers.length > 0) {
                badge.textContent = sleepingPlayers.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            console.log('[Sleeping] Parsed ' + sleepingPlayers.length + ' sleeping players');
            renderSleepingList();
        }

        function renderSleepingList() {
            var listEl = document.getElementById('sleeping-list');
            var emptyEl = document.getElementById('sleeping-list-empty');
            var searchTerm = (document.getElementById('sleeping-search').value || '').toLowerCase();

            var filtered = sleepingPlayers.filter(function(s) {
                return !searchTerm || s.steamId.indexOf(searchTerm) !== -1 ||
                    s.name.toLowerCase().indexOf(searchTerm) !== -1;
            });

            if (filtered.length === 0 && sleepingPlayers.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }
            emptyEl.classList.add('hidden');

            if (filtered.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 italic text-sm text-center py-8">No results matching "' + escapeHtml(searchTerm) + '"</p>';
                return;
            }

            listEl.innerHTML = '';
            filtered.forEach(function(s) {
                var card = document.createElement('div');
                card.className = 't-card rounded-lg border p-4 overview-card flex items-center gap-4';
                var avatarHtml = '<img data-steamid="' + escapeHtml(s.steamId) + '" src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\'%3E%3Crect width=\'40\' height=\'40\' rx=\'20\' fill=\'%231e293b\'/%3E%3Ctext x=\'20\' y=\'25\' text-anchor=\'middle\' fill=\'%23475569\' font-size=\'16\'%3E?%3C/text%3E%3C/svg%3E" class="w-10 h-10 rounded-full bg-slate-700 shrink-0 border-2 border-purple-900/50">';

                card.innerHTML =
                    avatarHtml +
                    '<div class="flex-1 min-w-0">' +
                        '<div class="flex items-center gap-2">' +
                            '<span class="text-sm font-medium truncate" style="color:var(--text-primary)">' + escapeHtml(s.name || 'Unknown') + '</span>' +
                            '<span class="text-[10px] px-1.5 py-0.5 rounded bg-purple-900/40 border border-purple-800/30 text-purple-400">Sleeping</span>' +
                        '</div>' +
                        '<div class="text-xs text-slate-500 console-font mt-0.5">' + escapeHtml(s.steamId) + '</div>' +
                        (s.health ? '<div class="text-xs text-slate-400 mt-1"><span class="text-slate-600">Health:</span> ' + escapeHtml(s.health) + '</div>' : '') +
                    '</div>' +
                    '<div class="flex gap-2 shrink-0">' +
                        '<a href="https://steamcommunity.com/profiles/' + escapeHtml(s.steamId) + '" target="_blank" class="text-[11px] px-2.5 py-1.5 rounded bg-slate-700/60 border border-slate-600/40 text-slate-300 hover:text-white hover:border-slate-500 transition" title="View Steam Profile">Steam</a>' +
                        '<button onclick="killSleeper(\'' + escapeHtml(s.steamId) + '\', \'' + escapeAttr(s.name || s.steamId) + '\')" class="text-[11px] px-2.5 py-1.5 rounded bg-orange-800/30 border border-orange-700/30 text-orange-400 hover:bg-orange-800/50 transition">Kill</button>' +
                        '<button onclick="banSleeper(\'' + escapeHtml(s.steamId) + '\', \'' + escapeAttr(s.name || s.steamId) + '\')" class="text-[11px] px-2.5 py-1.5 rounded bg-red-800/30 border border-red-700/30 text-red-400 hover:bg-red-800/50 transition">Ban</button>' +
                    '</div>';
                listEl.appendChild(card);

                // Load Steam avatar
                if (s.steamId && !steamProfileCache[s.steamId]) {
                    fetchSteamProfile(s.steamId);
                } else if (steamAvatarCache[s.steamId]) {
                    var img = card.querySelector('img[data-steamid="' + s.steamId + '"]');
                    if (img) img.src = steamAvatarCache[s.steamId];
                }
            });
        }

        function filterSleepingList() {
            renderSleepingList();
        }

        function killSleeper(steamId, name) {
            if (confirm('Kill sleeper ' + name + '?')) {
                sendCmd('kill ' + steamId);
                appendConsole('Killed sleeper ' + steamId, 'text-orange-400');
                showToast('Killed ' + name, 'success');
            }
        }

        function banSleeper(steamId, name) {
            if (confirm('Ban ' + name + '?')) {
                sendCmd('ban "' + steamId + '" "Banned by admin"');
                appendConsole('Banned ' + steamId, 'text-red-400');
                showToast('Banned ' + name, 'success');
                setTimeout(function() { refreshSleepingList(); }, 500);
            }
        }

        function refreshBanList() {
            var listEl = document.getElementById('ban-list');
            listEl.innerHTML = '<p class="text-slate-500 italic text-sm text-center py-8">Loading ban list...</p>';
            sendRequest('banlistex', function(data) {
                var msg = data.Message || '';
                console.log('[BanList] banlistex raw response:', msg);
                console.log('[BanList] Full data object:', JSON.stringify(data).substring(0, 1000));
                parseBanList(msg);
            });
        }

        function parseBanList(raw) {
            bannedPlayers = [];

            if (!raw || !raw.trim()) {
                console.log('[BanList] Empty response');
                banListLoaded = true;
                document.getElementById('ban-count-badge').classList.add('hidden');
                renderBanList();
                return;
            }

            // Try parsing as JSON first (banlistex often returns JSON array)
            try {
                var jsonData = JSON.parse(raw);
                console.log('[BanList] Parsed as JSON, type:', typeof jsonData, 'isArray:', Array.isArray(jsonData));
                if (Array.isArray(jsonData)) {
                    jsonData.forEach(function(entry) {
                        var steamId = entry.steamid || entry.SteamID || entry.id || entry.Id || '';
                        var name = entry.username || entry.Username || entry.name || entry.Name || entry.displayname || entry.DisplayName || '';
                        var reason = entry.reason || entry.Reason || entry.notes || entry.Notes || '';
                        var expiry = entry.expiry || entry.Expiry || entry.expire || entry.Expire || entry.expiryDate || '';
                        var duration = entry.duration || entry.Duration || '';

                        // Determine if permanent
                        var isPermanent = false;
                        var expiryDisplay = '';

                        if (expiry === -1 || expiry === '-1' || duration === -1 || duration === '-1') {
                            isPermanent = true;
                            expiryDisplay = 'Permanent';
                        } else if (typeof expiry === 'number' && expiry > 1000000000) {
                            var d = new Date(expiry * 1000);
                            expiryDisplay = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                            if (d < new Date()) expiryDisplay += ' (expired)';
                        } else if (typeof expiry === 'string' && expiry) {
                            var ts = parseInt(expiry);
                            if (ts > 1000000000) {
                                var d2 = new Date(ts * 1000);
                                expiryDisplay = d2.toLocaleDateString() + ' ' + d2.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                                if (d2 < new Date()) expiryDisplay += ' (expired)';
                            } else {
                                expiryDisplay = expiry;
                            }
                        }

                        if (steamId) {
                            bannedPlayers.push({
                                steamId: String(steamId),
                                name: name,
                                reason: reason,
                                expiry: expiryDisplay,
                                isPermanent: isPermanent,
                                raw: JSON.stringify(entry)
                            });
                        }
                    });
                    console.log('[BanList] Parsed ' + bannedPlayers.length + ' bans from JSON array');
                } else if (typeof jsonData === 'object') {
                    // Single object ‚Äî might be wrapped
                    console.log('[BanList] JSON object keys:', Object.keys(jsonData));
                }
            } catch(e) {
                console.log('[BanList] Not JSON, parsing as text');
                // Parse as text lines
                var text = raw.replace(/\\n/g, '\n').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                var lines = text.split('\n');

                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line) continue;

                    // Skip header/count lines
                    if (/^steamid/i.test(line)) continue;
                    if (/^\d+\s+bans?\s/i.test(line)) continue;
                    if (/^listing/i.test(line)) continue;
                    if (/^total:/i.test(line)) continue;

                    // Try to parse: # SteamID "Name" "Reason" Duration/Expiry
                    // Format: 1 76561198056745387 "name" "reason" -1
                    var match = line.match(/^(?:\d+\s+)?(\d{17})\s+"([^"]*)"\s+"([^"]*)"\s+(.+)$/);
                    if (match) {
                        var expTxt = match[4].trim();
                        var isPerm = expTxt === '-1' || /perm/i.test(expTxt);
                        var expDisp = '';
                        if (isPerm) {
                            expDisp = 'Permanent';
                        } else {
                            var tsv = parseInt(expTxt);
                            if (tsv > 1000000000) {
                                var dt = new Date(tsv * 1000);
                                expDisp = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                                if (dt < new Date()) expDisp += ' (expired)';
                            } else {
                                expDisp = expTxt;
                            }
                        }
                        bannedPlayers.push({
                            steamId: match[1],
                            name: match[2],
                            reason: match[3],
                            expiry: expDisp,
                            isPermanent: isPerm,
                            raw: line
                        });
                        continue;
                    }

                    // Fallback: try space-separated without quotes
                    var parts = line.match(/^(?:\d+\s+)?(\d{17})\s+(.+)/);
                    if (parts) {
                        bannedPlayers.push({
                            steamId: parts[1],
                            name: '',
                            reason: parts[2].trim(),
                            expiry: '',
                            isPermanent: false,
                            raw: line
                        });
                    }
                }
                console.log('[BanList] Parsed ' + bannedPlayers.length + ' bans from text');
            }

            banListLoaded = true;
            var badge = document.getElementById('ban-count-badge');
            if (bannedPlayers.length > 0) {
                badge.textContent = bannedPlayers.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            renderBanList();
        }

        function renderBanList() {
            var listEl = document.getElementById('ban-list');
            var emptyEl = document.getElementById('ban-list-empty');
            var searchTerm = (document.getElementById('ban-search').value || '').toLowerCase();

            var filtered = bannedPlayers.filter(function(b) {
                return !searchTerm || b.steamId.indexOf(searchTerm) !== -1 ||
                    b.name.toLowerCase().indexOf(searchTerm) !== -1 ||
                    b.reason.toLowerCase().indexOf(searchTerm) !== -1;
            });

            if (filtered.length === 0 && bannedPlayers.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }
            emptyEl.classList.add('hidden');

            if (filtered.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 italic text-sm text-center py-8">No results matching "' + escapeHtml(searchTerm) + '"</p>';
                return;
            }

            listEl.innerHTML = '';
            filtered.forEach(function(b, idx) {
                var card = document.createElement('div');
                card.className = 't-card rounded-lg border p-4 overview-card flex items-center gap-4';
                var avatarHtml = '<img data-steamid="' + escapeHtml(b.steamId) + '" src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\'%3E%3Crect width=\'40\' height=\'40\' rx=\'20\' fill=\'%231e293b\'/%3E%3Ctext x=\'20\' y=\'25\' text-anchor=\'middle\' fill=\'%23475569\' font-size=\'16\'%3E?%3C/text%3E%3C/svg%3E" class="w-10 h-10 rounded-full bg-slate-700 shrink-0 border-2 border-red-900/50">';

                var permBadge = b.isPermanent
                    ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-red-900/50 border border-red-800/30 text-red-400 font-medium">PERMANENT</span>'
                    : (b.expiry ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-yellow-900/40 border border-yellow-800/30 text-yellow-400">' + escapeHtml(b.expiry) + '</span>' : '');

                card.innerHTML =
                    avatarHtml +
                    '<div class="flex-1 min-w-0">' +
                        '<div class="flex items-center gap-2">' +
                            '<span class="text-sm font-medium truncate" style="color:var(--text-primary)">' + escapeHtml(b.name || 'Unknown') + '</span>' +
                            permBadge +
                        '</div>' +
                        '<div class="text-xs text-slate-500 console-font mt-0.5">' + escapeHtml(b.steamId) + '</div>' +
                        (b.reason ? '<div class="text-xs text-slate-400 mt-1 truncate"><span class="text-slate-600">Reason:</span> ' + escapeHtml(b.reason) + '</div>' : '') +
                    '</div>' +
                    '<div class="flex gap-2 shrink-0">' +
                        '<a href="https://steamcommunity.com/profiles/' + escapeHtml(b.steamId) + '" target="_blank" class="text-[11px] px-2.5 py-1.5 rounded bg-slate-700/60 border border-slate-600/40 text-slate-300 hover:text-white hover:border-slate-500 transition" title="View Steam Profile">Steam</a>' +
                        '<button onclick="unbanPlayer(\'' + escapeHtml(b.steamId) + '\', \'' + escapeAttr(b.name || b.steamId) + '\')" class="text-[11px] px-2.5 py-1.5 rounded bg-green-800/30 border border-green-700/30 text-green-400 hover:bg-green-800/50 transition">Unban</button>' +
                    '</div>';
                listEl.appendChild(card);

                // Try to load Steam avatar
                if (b.steamId && !steamProfileCache[b.steamId]) {
                    fetchSteamProfile(b.steamId);
                } else if (steamAvatarCache[b.steamId]) {
                    var img = card.querySelector('img[data-steamid="' + b.steamId + '"]');
                    if (img) img.src = steamAvatarCache[b.steamId];
                }
            });
        }

        function filterBanList() {
            renderBanList();
        }

        function unbanPlayer(steamId, name) {
            if (confirm('Unban ' + name + '?')) {
                sendCmd('unban ' + steamId);
                appendConsole('Unbanned ' + steamId, 'text-green-400');
                showToast('Unbanned ' + name, 'success');
                // Refresh after a short delay to let the server process it
                setTimeout(function() { refreshBanList(); }, 500);
            }
        }

        // ========== PLAYER DETAIL PANEL ==========
        var steamAvatarCache = {};
        var steamProfileCache = {};

        function loadSteamAvatars(players) {
            players.forEach(function(p) {
                if (!p.SteamID) return;
                if (steamProfileCache[p.SteamID]) {
                    // Apply cached avatar to any new DOM elements
                    var url = steamAvatarCache[p.SteamID];
                    if (url) {
                        var imgs = document.querySelectorAll('img[data-steamid="' + p.SteamID + '"]');
                        imgs.forEach(function(img) { img.src = url; });
                    }
                    return;
                }
                fetchSteamProfile(p.SteamID);
            });
        }

        function fetchSteamProfile(steamId) {
            if (steamProfileCache[steamId]) return;
            fetch('/api/steam/' + steamId)
                .then(function(r) { return r.json(); })
                .then(function(profile) {
                    steamProfileCache[steamId] = profile;
                    if (profile.avatarMedium) {
                        steamAvatarCache[steamId] = profile.avatarMedium;
                        var imgs = document.querySelectorAll('img[data-steamid="' + steamId + '"]');
                        imgs.forEach(function(img) { img.src = profile.avatarMedium; });
                    }
                    // Update detail panel if it's showing this player
                    var pdSteamId = document.getElementById('pd-steamid');
                    if (pdSteamId && pdSteamId.textContent === steamId) {
                        populateDetailFromProfile(profile);
                    }
                })
                .catch(function() {});
        }

        function populateDetailFromProfile(profile) {
            if (profile.avatarFull) {
                document.getElementById('pd-avatar').src = profile.avatarFull;
            }
            var extraEl = document.getElementById('pd-extra');
            if (!extraEl) return;
            var html = '';
            if (profile.realName) html += '<div class="flex justify-between"><span class="t-muted">Real Name</span><span class="console-font">' + escapeHtml(profile.realName) + '</span></div>';
            if (profile.location) html += '<div class="flex justify-between"><span class="t-muted">Location</span><span class="console-font">' + escapeHtml(profile.location) + '</span></div>';
            if (profile.memberSince) html += '<div class="flex justify-between"><span class="t-muted">Member Since</span><span class="console-font">' + escapeHtml(profile.memberSince) + '</span></div>';
            if (profile.onlineState) {
                var stateColor = profile.onlineState === 'online' ? 'text-green-400' : profile.onlineState === 'in-game' ? 'text-green-400' : 'text-slate-400';
                html += '<div class="flex justify-between"><span class="t-muted">Steam Status</span><span class="console-font ' + stateColor + '">' + escapeHtml(profile.onlineState) + '</span></div>';
            }
            if (profile.vacBanned) html += '<div class="flex justify-between"><span class="t-muted">VAC Status</span><span class="console-font text-red-400">BANNED</span></div>';
            if (profile.isPrivate) html += '<div class="text-xs text-slate-500 italic mt-1">Profile is private</div>';
            extraEl.innerHTML = html;
        }

        function showPlayerDetail(playerIndex) {
            var p = currentPlayers[playerIndex];
            if (!p) return;

            var panel = document.getElementById('player-detail');
            panel.classList.remove('hidden');

            var steamId = p.SteamID || '';
            var name = p.DisplayName || 'Unknown';
            var ping = p.Ping || 0;
            var ip = p.Address ? p.Address.split(':')[0] : 'N/A';
            var connected = p.ConnectedSeconds || 0;
            var health = p.Health != null ? Math.round(p.Health) : '--';
            var violations = p.CurrentLevel != null ? p.CurrentLevel : (p.VoicelevelViolations || 0);

            // Format connected time
            var ch = Math.floor(connected / 3600);
            var cm = Math.floor((connected % 3600) / 60);
            var connectedStr = ch > 0 ? ch + 'h ' + cm + 'm' : cm + 'm';

            // Ping color
            var pingColor = ping < 100 ? 'text-green-400' : (ping < 200 ? 'text-yellow-400' : 'text-red-400');

            document.getElementById('pd-name').textContent = name;
            document.getElementById('pd-steamid').textContent = steamId;
            document.getElementById('pd-ping').innerHTML = '<span class="' + pingColor + '">' + ping + 'ms</span>';
            document.getElementById('pd-ip').textContent = ip;
            document.getElementById('pd-connected').textContent = connectedStr;
            document.getElementById('pd-health').innerHTML = health !== '--' ? '<span class="' + (health > 50 ? 'text-green-400' : health > 20 ? 'text-yellow-400' : 'text-red-400') + '">' + health + '</span>' : '--';
            document.getElementById('pd-violations').textContent = violations;

            // Avatar - use cached or default
            var avatar = document.getElementById('pd-avatar');
            if (steamAvatarCache[steamId]) {
                avatar.src = steamAvatarCache[steamId].replace('_medium', '_full');
            } else {
                avatar.src = 'https://avatars.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg';
            }

            // Clear extra info then populate from cache or fetch
            document.getElementById('pd-extra').innerHTML = '<div class="text-xs text-slate-500 italic">Loading Steam profile...</div>';
            if (steamProfileCache[steamId]) {
                populateDetailFromProfile(steamProfileCache[steamId]);
            } else {
                fetchSteamProfile(steamId);
            }

            // Links
            document.getElementById('pd-steam-link').href = 'https://steamcommunity.com/profiles/' + steamId;
            document.getElementById('pd-battlemetrics-link').href = 'https://www.battlemetrics.com/rcon/players?filter%5Bsearch%5D=' + steamId;

            // Action buttons (use playerIndex to look up raw data)
            document.getElementById('pd-kill-btn').onclick = function() { killPlayer(playerIndex); };
            var pdMuteBtn = document.getElementById('pd-mute-btn');
            pdMuteBtn.textContent = mutedPlayers[steamId] ? 'Unmute' : 'Mute';
            pdMuteBtn.className = 'flex-1 text-xs px-2 py-2 rounded transition ' + (mutedPlayers[steamId] ? 'bg-purple-500/70 hover:bg-purple-400' : 'bg-purple-700/50 hover:bg-purple-600');
            pdMuteBtn.onclick = function() { toggleMutePlayer(playerIndex); };
            document.getElementById('pd-kick-btn').onclick = function() { kickPlayer(playerIndex); };
            document.getElementById('pd-ban-btn').onclick = function() { banPlayer(playerIndex); };

            // Highlight selected player in list
            document.querySelectorAll('#player-list .player-card').forEach(function(card, i) {
                card.classList.toggle('ring-1', i === playerIndex);
                card.classList.toggle('ring-sky-500/50', i === playerIndex);
            });
        }

        function closePlayerDetail() {
            document.getElementById('player-detail').classList.add('hidden');
            document.querySelectorAll('#player-list .player-card').forEach(function(card) {
                card.classList.remove('ring-1', 'ring-sky-500/50');
            });
        }

        // ========== TABS ==========
        function switchTab(tab) {
            var tabs = ['overview', 'players', 'console', 'inventory', 'plugins'];
            tabs.forEach(function(t) {
                var el = document.getElementById(t + '-tab');
                if (el) el.classList.add('hidden');
            });
            var target = document.getElementById(tab + '-tab');
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');
            }
            document.querySelectorAll('.sidebar-btn[data-tab]').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) btn.classList.add('active');
            });
            if (tab === 'console') document.getElementById('cmd-input').focus();
            if (tab === 'overview') refreshServerInfoSilent();
            if (tab === 'plugins' && !pluginsLoaded) refreshPlugins();
        }

        // ========== ITEMS DATABASE ==========
        var allItems = [];
        var itemsLoaded = false;

        function loadItems() {
            fetch('/items.json')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    allItems = data;
                    itemsLoaded = true;
                    renderItemBrowser('');
                    document.getElementById('item-browser-count').textContent = allItems.length + ' items';
                })
                .catch(function(err) {
                    console.error('Failed to load items:', err);
                });
        }
        loadItems();

        // ========== ITEM SEARCH DROPDOWN (form input) ==========
        var itemSearchInput = document.getElementById('item-search');
        var itemDropdown = document.getElementById('item-dropdown');
        var itemSearchTimeout = null;

        itemSearchInput.addEventListener('input', function() {
            clearTimeout(itemSearchTimeout);
            itemSearchTimeout = setTimeout(function() {
                var q = itemSearchInput.value.trim().toLowerCase();
                if (q.length < 1) { itemDropdown.classList.add('hidden'); return; }
                var matches = allItems.filter(function(item) {
                    return item.name.toLowerCase().indexOf(q) !== -1 ||
                           item.shortname.toLowerCase().indexOf(q) !== -1 ||
                           String(item.itemid).indexOf(q) !== -1;
                }).slice(0, 30);
                if (matches.length === 0) {
                    itemDropdown.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500">No items found</div>';
                } else {
                    itemDropdown.innerHTML = matches.map(function(item) {
                        return '<button type="button" onclick="selectItem(\'' + escapeAttr(item.shortname) + '\', \'' + escapeAttr(item.name) + '\', ' + item.stacksize + ')" class="w-full text-left px-3 py-2 hover:bg-slate-800 flex items-center gap-3 text-sm border-b border-slate-800/50 last:border-0 transition">' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="text-slate-200 truncate">' + escapeHtml(item.name) + '</div>' +
                                '<div class="text-xs text-slate-500 truncate">' + escapeHtml(item.shortname) + '</div>' +
                            '</div>' +
                            '<span class="text-xs text-slate-600 shrink-0">x' + item.stacksize + '</span>' +
                        '</button>';
                    }).join('');
                }
                itemDropdown.classList.remove('hidden');
            }, 120);
        });

        itemSearchInput.addEventListener('focus', function() {
            if (itemSearchInput.value.trim().length >= 1) {
                itemSearchInput.dispatchEvent(new Event('input'));
            }
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('#item-search') && !e.target.closest('#item-dropdown')) {
                itemDropdown.classList.add('hidden');
            }
        });

        function escapeAttr(s) {
            return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function selectItem(shortname, name, stacksize) {
            document.getElementById('item-id').value = shortname;
            document.getElementById('item-search').value = '';
            itemDropdown.classList.add('hidden');
            // Show selection card
            document.getElementById('item-selected').classList.remove('hidden');
            document.getElementById('item-sel-name').textContent = name;
            document.getElementById('item-sel-short').textContent = shortname;
            document.getElementById('item-sel-stack').textContent = 'Stack: ' + stacksize;
            document.getElementById('item-amount').max = stacksize;
        }

        function clearItemSelection() {
            document.getElementById('item-id').value = '';
            document.getElementById('item-selected').classList.add('hidden');
            document.getElementById('item-search').value = '';
            document.getElementById('item-amount').removeAttribute('max');
        }

        // ========== ITEM QUEUE ==========
        var itemQueue = [];

        function addToQueue() {
            var item = document.getElementById('item-id').value.trim();
            var amount = parseInt(document.getElementById('item-amount').value) || 1;
            if (!item) {
                showToast('Please select an item first', 'error');
                return;
            }
            var nameEl = document.getElementById('item-sel-name');
            var displayName = nameEl ? nameEl.textContent : item;
            itemQueue.push({ shortname: item, name: displayName, amount: amount });
            renderQueue();
            clearItemSelection();
            document.getElementById('item-amount').value = 1;
            showToast('Added ' + amount + 'x ' + displayName + ' to queue', 'info');
        }

        function removeFromQueue(index) {
            itemQueue.splice(index, 1);
            renderQueue();
        }

        function clearQueue() {
            itemQueue = [];
            renderQueue();
        }

        function renderQueue() {
            var section = document.getElementById('item-queue-section');
            var list = document.getElementById('item-queue-list');
            var badge = document.getElementById('queue-count-badge');
            if (itemQueue.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');
            badge.textContent = itemQueue.length;
            list.innerHTML = itemQueue.map(function(q, i) {
                return '<div class="flex items-center justify-between bg-slate-900/80 border border-slate-700/50 rounded px-3 py-2 text-xs">' +
                    '<div class="flex-1 min-w-0"><span class="text-slate-200 font-medium">' + escapeHtml(q.name) + '</span>' +
                    '<span class="text-slate-500 ml-2">' + escapeHtml(q.shortname) + '</span></div>' +
                    '<span class="text-sky-400 font-medium mx-2">x' + q.amount + '</span>' +
                    '<button onclick="removeFromQueue(' + i + ')" class="text-slate-500 hover:text-red-400 transition">&times;</button></div>';
            }).join('');
        }

        function sendQueue() {
            var player = document.getElementById('target-player').value.trim();
            if (!player) {
                showToast('Please select a player first', 'error');
                return;
            }
            if (itemQueue.length === 0) {
                showToast('Queue is empty', 'error');
                return;
            }
            var count = itemQueue.length;
            var summary = [];
            itemQueue.forEach(function(q) {
                sendCmd('inventory.giveto "' + player + '" "' + q.shortname + '" ' + q.amount);
                summary.push(q.amount + 'x ' + q.name);
            });
            showToast('Sent ' + count + ' item(s) to ' + player + ':\n' + summary.join(', '), 'success');
            appendConsole('Gave ' + count + ' item(s) to ' + player + ': ' + summary.join(', '), 'text-green-400');
            itemQueue = [];
            renderQueue();
        }

        function giveItem() {
            var player = document.getElementById('target-player').value.trim();
            var item = document.getElementById('item-id').value.trim();
            var amount = parseInt(document.getElementById('item-amount').value) || 1;
            if (!player || !item) {
                showToast('Player and Item are required', 'error');
                return;
            }
            var nameEl = document.getElementById('item-sel-name');
            var displayName = nameEl ? nameEl.textContent : item;
            sendCmd('inventory.giveto "' + player + '" "' + item + '" ' + amount);
            showToast('Gave ' + amount + 'x ' + displayName + ' to ' + player, 'success');
            appendConsole('Gave ' + amount + 'x ' + item + ' to ' + player, 'text-green-400');
        }

        // ========== TOAST NOTIFICATIONS ==========
        function showToast(message, type) {
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');
            var colors = {
                success: 'border-green-500/50 bg-green-950/90 text-green-200',
                error: 'border-red-500/50 bg-red-950/90 text-red-200',
                info: 'border-sky-500/50 bg-sky-950/90 text-sky-200'
            };
            var icons = { success: '\u2705', error: '\u274C', info: '\u2139\uFE0F' };
            toast.className = 'flex items-start gap-3 px-4 py-3 rounded-lg border shadow-lg backdrop-blur-sm text-sm max-w-sm animate-slide-in ' + (colors[type] || colors.info);
            toast.innerHTML = '<span class="text-base mt-0.5">' + (icons[type] || icons.info) + '</span>' +
                '<div class="flex-1 min-w-0"><p class="whitespace-pre-wrap">' + escapeHtml(message) + '</p></div>' +
                '<button onclick="this.parentElement.remove()" class="opacity-60 hover:opacity-100 text-lg leading-none mt-0.5">&times;</button>';
            container.appendChild(toast);
            setTimeout(function() {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(function() { toast.remove(); }, 300);
            }, 4000);
        }

        // ========== ITEM BROWSER (right panel) ==========
        var browserSearchInput = document.getElementById('item-browser-search');
        var browserSearchTimeout = null;

        browserSearchInput.addEventListener('input', function() {
            clearTimeout(browserSearchTimeout);
            browserSearchTimeout = setTimeout(function() {
                renderItemBrowser(browserSearchInput.value.trim().toLowerCase());
            }, 150);
        });

        function renderItemBrowser(q) {
            var list = document.getElementById('item-browser-list');
            var countEl = document.getElementById('item-browser-count');
            var filtered = allItems;
            if (q) {
                filtered = allItems.filter(function(item) {
                    return item.name.toLowerCase().indexOf(q) !== -1 ||
                           item.shortname.toLowerCase().indexOf(q) !== -1 ||
                           item.description.toLowerCase().indexOf(q) !== -1;
                });
            }
            countEl.textContent = filtered.length + ' items';
            // Render max 150 for performance
            var toRender = filtered.slice(0, 150);
            list.innerHTML = toRender.map(function(item) {
                return '<button onclick="selectItem(\'' + escapeAttr(item.shortname) + '\', \'' + escapeAttr(item.name) + '\', ' + item.stacksize + ')" class="text-left bg-slate-800/40 hover:bg-slate-700/60 border border-slate-700/30 rounded-lg p-3 transition group">' +
                    '<div class="text-sm text-slate-200 font-medium truncate group-hover:text-white">' + escapeHtml(item.name) + '</div>' +
                    '<div class="text-xs text-slate-500 truncate mt-0.5">' + escapeHtml(item.shortname) + '</div>' +
                    '<div class="text-xs text-slate-600 truncate mt-1 leading-snug">' + escapeHtml(item.description.substring(0, 80)) + (item.description.length > 80 ? '...' : '') + '</div>' +
                    '<div class="flex items-center gap-3 mt-2 text-xs text-slate-600">' +
                        '<span>ID: ' + item.itemid + '</span>' +
                        '<span>Stack: ' + item.stacksize + '</span>' +
                    '</div>' +
                '</button>';
            }).join('');
            if (filtered.length > 150) {
                list.innerHTML += '<div class="col-span-full text-center text-xs text-slate-600 py-3">Showing 150 of ' + filtered.length + ' ‚Äî refine your search</div>';
            }
            if (filtered.length === 0) {
                list.innerHTML = '<div class="col-span-full text-center text-sm text-slate-500 py-8">No items match "' + escapeHtml(q) + '"</div>';
            }
        }

        function refreshServerInfo() {
            refreshServerInfoSilent();
            fetchWorldInfo();
            fetchServerIP();
            fetchWeatherConvars();
        }

        // Silent refresh: uses sendRequest (Identifier > 1000) so response doesn't go through handleRconMessage
        function refreshServerInfoSilent() {
            sendRequest('serverinfo', function(data) {
                if (!data.Message) return;
                try {
                    var info = JSON.parse(data.Message);
                    lastServerInfo = info;
                    updateStatsUI(info);
                    updateOverviewFromInfo(info);
                } catch(e) {}
            });
            fetchGameTime();
        }

        // ========== GAME TIME (env.time) ==========
        var cachedGameTime = '--';

        function fetchGameTime() {
            sendRequest('env.time', function(data) {
                var msg = (data.Message || '').trim();
                // env.time returns something like 'env.time: "12.5"' or just a number
                var match = msg.match(/(\d+\.?\d*)/);
                if (match) {
                    var hours = parseFloat(match[1]);
                    var h = Math.floor(hours);
                    var m = Math.round((hours - h) * 60);
                    if (m === 60) { h++; m = 0; }
                    if (h >= 24) h -= 24;
                    cachedGameTime = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
                    document.getElementById('stat-gametime').textContent = cachedGameTime;
                    var cycle = (hours >= 6 && hours < 18) ? 'Daytime' : 'Nighttime';
                    var icon = (hours >= 6 && hours < 18) ? '\u2600' : '\u263D';
                    document.getElementById('stat-daycycle').textContent = icon + ' ' + cycle;
                }
            });
        }

        // ========== WEATHER CONVARS ==========

        // Toggle state and convar mapping (with on/off values)
        var weatherToggles = {
            fog:     { enabled: false, convar: 'weather.fog_multiplier', onVal: '200', offVal: '0' },
            rain:    { enabled: false, convar: 'weather.rain',           onVal: '1',   offVal: '0' },
            clouds:  { enabled: false, convar: 'weather.overcast_chance',onVal: '1',   offVal: '0' },
            wind:    { enabled: false, convar: 'weather.wind',           onVal: '1',   offVal: '0' },
            thunder: { enabled: false, convar: 'weather.thunder',        onVal: '1',   offVal: '0' }
        };

        function toggleWeather(name) {
            var t = weatherToggles[name];
            t.enabled = !t.enabled;
            var toggle = document.getElementById('weather-' + name + '-toggle');
            var dot = document.getElementById('weather-' + name + '-dot');
            if (t.enabled) {
                toggle.className = 'relative w-12 h-6 rounded-full bg-sky-600 transition-colors cursor-pointer';
                dot.className = 'absolute top-0.5 left-[26px] w-5 h-5 rounded-full bg-white transition-all';
                sendRequest(t.convar + ' ' + t.onVal, function() {});
            } else {
                toggle.className = 'relative w-12 h-6 rounded-full bg-slate-700 transition-colors cursor-pointer';
                dot.className = 'absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-all';
                sendRequest(t.convar + ' ' + t.offVal, function() {});
            }
        }

        function setToggleUI(name, enabled) {
            weatherToggles[name].enabled = enabled;
            var toggle = document.getElementById('weather-' + name + '-toggle');
            var dot = document.getElementById('weather-' + name + '-dot');
            if (enabled) {
                toggle.className = 'relative w-12 h-6 rounded-full bg-sky-600 transition-colors cursor-pointer';
                dot.className = 'absolute top-0.5 left-[26px] w-5 h-5 rounded-full bg-white transition-all';
            } else {
                toggle.className = 'relative w-12 h-6 rounded-full bg-slate-700 transition-colors cursor-pointer';
                dot.className = 'absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-all';
            }
        }

        function fetchWeatherConvars() {
            // Fetch time
            sendRequest('env.time', function(data) {
                var msg = (data.Message || '').trim();
                var match = msg.match(/(\d+\.?\d*)/);
                if (match) {
                    var val = parseFloat(match[0]);
                    var slider = document.getElementById('weather-time');
                    var label = document.getElementById('weather-time-val');
                    if (slider) slider.value = val;
                    if (label) label.textContent = formatTime(val);
                }
            });
            // Fetch toggle states
            Object.keys(weatherToggles).forEach(function(name) {
                var t = weatherToggles[name];
                sendRequest(t.convar, function(data) {
                    var msg = (data.Message || '').trim();
                    var match = msg.match(/-?(\d+\.?\d*)/);
                    if (match) {
                        setToggleUI(name, parseFloat(match[0]) > 0);
                    }
                });
            });
        }

        function formatTime(hours) {
            var h = Math.floor(hours);
            var m = Math.round((hours - h) * 60);
            var suffix = h >= 12 ? 'PM' : 'AM';
            var h12 = h % 12 || 12;
            return h12 + ':' + (m < 10 ? '0' : '') + m + ' ' + suffix;
        }

        function setTimeConvar(value) {
            var val = parseFloat(value);
            var label = document.getElementById('weather-time-val');
            if (label) label.textContent = formatTime(val);
            sendRequest('env.time ' + val, function() {});
        }

        function resetWeather() {
            // Reset all toggles
            Object.keys(weatherToggles).forEach(function(name) {
                setToggleUI(name, false);
                sendRequest(weatherToggles[name].convar + ' ' + weatherToggles[name].offVal, function() {});
            });
            // Reset time to noon
            var timeSlider = document.getElementById('weather-time');
            var timeLabel = document.getElementById('weather-time-val');
            if (timeSlider) timeSlider.value = 12;
            if (timeLabel) timeLabel.textContent = formatTime(12);
            sendRequest('env.time 12', function() {});
        }

        // ========== SERVER IP ==========
        var cachedServerIP = '--';

        function fetchServerIP() {
            if (!rconHost) return;
            fetch('/api/resolve/' + encodeURIComponent(rconHost))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.ip) {
                        cachedServerIP = data.ip;
                    }
                    var el = document.getElementById('srv-ip');
                    if (el) el.textContent = cachedServerIP !== '--' && rconPort ? cachedServerIP + ':' + rconPort : cachedServerIP;
                })
                .catch(function() {});
        }

        // ========== WORLD INFO (separate commands) ==========
        var cachedWorldSize = '--';
        var cachedSeed = '--';

        function fetchWorldInfo() {
            sendRequest('server.worldsize', function(data) {
                var msg = (data.Message || '').trim();
                // Response format: 'server.worldsize: "5000"'
                var match = msg.match(/server\.worldsize:\s*"?(\d+)"?/i);
                if (match) {
                    cachedWorldSize = parseInt(match[1], 10);
                } else {
                    // Fallback: just grab first number
                    var numMatch = msg.match(/(\d+)/);
                    if (numMatch) cachedWorldSize = parseInt(numMatch[1], 10);
                    else if (msg) cachedWorldSize = msg;
                }
                applyWorldInfo();
            });
            sendRequest('server.seed', function(data) {
                var msg = (data.Message || '').trim();
                // Response format: 'server.seed: "1157215487"'
                var match = msg.match(/server\.seed:\s*"?(\d+)"?/i);
                if (match) {
                    cachedSeed = parseInt(match[1], 10);
                } else {
                    var numMatch = msg.match(/(\d+)/);
                    if (numMatch) cachedSeed = parseInt(numMatch[1], 10);
                    else if (msg) cachedSeed = msg;
                }
                applyWorldInfo();
            });
        }

        function applyWorldInfo() {
            var el;
            el = document.getElementById('world-size');
            if (el) el.textContent = typeof cachedWorldSize === 'number' ? cachedWorldSize.toLocaleString() + 'm' : cachedWorldSize;
            el = document.getElementById('world-seed');
            if (el) el.textContent = cachedSeed;
        }

        function updateOverviewFromInfo(info) {
            // Update connection status cards
            var connEl = document.getElementById('overview-connection');
            if (connEl) { connEl.textContent = 'Connected'; connEl.className = 'text-lg font-bold text-green-400'; }
            var playersEl = document.getElementById('overview-players');
            if (playersEl) playersEl.textContent = (info.Players || 0) + ' / ' + (info.MaxPlayers || 0);
            var serverEl = document.getElementById('overview-server');
            if (serverEl) serverEl.textContent = info.Hostname || '...';
            // Update saved server label with actual hostname
            if (info.Hostname && rconHost && rconPort) {
                saveCurrentServer(rconHost, rconPort, rconPassword, info.Hostname);
            }
            // World size & seed come from dedicated commands
            applyWorldInfo();
        }

        // ========== SERVER STATS ==========
        var fpsHistory = [];
        var entityHistory = [];
        var maxHistoryPoints = 60;
        var lastServerInfo = null;
        var statsRefreshInterval = null;

        function refreshStats() {
            sendRequest('serverinfo', function(data) {
                if (!data.Message) return;
                try {
                    var info = JSON.parse(data.Message);
                    lastServerInfo = info;
                    updateStatsUI(info);
                } catch(e) {
                    appendConsole('Failed to parse serverinfo: ' + e.message, 'text-red-400');
                }
            });
        }

        function updateStatsUI(info) {
            // Update timestamp
            var now = new Date().toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('stats-last-update').textContent = 'Updated ' + now;

            // Top KPIs
            var fps = Math.round(info.Framerate || 0);
            document.getElementById('stat-fps').textContent = fps;
            document.getElementById('stat-fps').className = 'text-2xl font-bold ' + (fps >= 20 ? 'text-green-400' : fps >= 10 ? 'text-yellow-400' : 'text-red-400');

            var entities = info.EntityCount || 0;
            document.getElementById('stat-entities').textContent = entities.toLocaleString();

            // Game time is updated separately via env.time
            document.getElementById('stat-gametime').textContent = cachedGameTime;

            var online = info.Players || 0;
            var max = info.MaxPlayers || 0;
            document.getElementById('stat-players').textContent = online + ' / ' + max;
            var queued = info.Queued || 0;
            var joining = info.Joining || 0;
            document.getElementById('stat-queue').textContent = queued > 0 ? queued + ' queued, ' + joining + ' joining' : joining > 0 ? joining + ' joining' : 'No queue';

            // Performance card
            document.getElementById('perf-fps').textContent = fps + ' fps';
            document.getElementById('perf-memory').textContent = (info.Memory || 0).toLocaleString() + ' MB';
            document.getElementById('perf-collections').textContent = (info.Collections || 0).toLocaleString();
            document.getElementById('perf-uptime').textContent = formatUptime(info.Uptime || 0);

            // Network card
            document.getElementById('net-in').textContent = formatBytes(info.NetworkIn || 0) + '/s';
            document.getElementById('net-out').textContent = formatBytes(info.NetworkOut || 0) + '/s';
            document.getElementById('net-players').textContent = online;
            document.getElementById('net-queued').textContent = queued;
            document.getElementById('net-joining').textContent = joining;

            // World card
            document.getElementById('world-map').textContent = info.Map || '--';
            // world-size and world-seed are populated by applyWorldInfo() from dedicated commands
            applyWorldInfo();
            document.getElementById('world-entities').textContent = entities.toLocaleString();
            document.getElementById('world-save').textContent = info.SaveCreatedTime || '--';

            // Server identity card
            document.getElementById('srv-hostname').textContent = info.Hostname || '--';
            document.getElementById('srv-hostname').title = info.Hostname || '';
            document.getElementById('srv-dns').textContent = rconHost || '--';
            // srv-ip is populated by fetchServerIP()
            document.getElementById('srv-maxplayers').textContent = (info.Players || 0) + ' / ' + max;
            document.getElementById('srv-restarting').textContent = info.Restarting ? 'Yes' : 'No';
            document.getElementById('srv-restarting').className = 'console-font ' + (info.Restarting ? 'text-red-400' : 'text-green-400');
            document.getElementById('srv-protocol').textContent = info.Protocol || '--';

            // History tracking
            fpsHistory.push(fps);
            if (fpsHistory.length > maxHistoryPoints) fpsHistory.shift();
            entityHistory.push(entities);
            if (entityHistory.length > maxHistoryPoints) entityHistory.shift();

            drawSparkline('fps-chart', fpsHistory, '#38bdf8');
            drawSparkline('entity-chart', entityHistory, '#fbbf24');

            // Keep overview in sync
            updateOverviewFromInfo(info);
        }

        function formatUptime(seconds) {
            var d = Math.floor(seconds / 86400);
            var h = Math.floor((seconds % 86400) / 3600);
            var m = Math.floor((seconds % 3600) / 60);
            if (d > 0) return d + 'd ' + h + 'h ' + m + 'm';
            if (h > 0) return h + 'h ' + m + 'm';
            return m + 'm';
        }

        function formatBytes(bytes) {
            if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + ' MB';
            if (bytes >= 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return bytes + ' B';
        }

        function drawSparkline(canvasId, data, color) {
            var canvas = document.getElementById(canvasId);
            if (!canvas || data.length < 2) return;
            var ctx = canvas.getContext('2d');
            var w = canvas.width;
            var h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            var min = Math.min.apply(null, data);
            var max = Math.max.apply(null, data);
            var range = max - min || 1;

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.lineJoin = 'round';

            for (var i = 0; i < data.length; i++) {
                var x = (i / (data.length - 1)) * w;
                var y = h - ((data[i] - min) / range) * (h - 4) - 2;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Fill under line
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fillStyle = color.replace(')', ', 0.1)').replace('rgb', 'rgba');
            ctx.globalAlpha = 0.15;
            ctx.fill();
            ctx.globalAlpha = 1;
        }

        // Auto-refresh stats on overview tab
        function startStatsAutoRefresh() {
            if (statsRefreshInterval) clearInterval(statsRefreshInterval);
            statsRefreshInterval = setInterval(function() {
                var overviewTab = document.getElementById('overview-tab');
                if (overviewTab && !overviewTab.classList.contains('hidden') && socket && socket.readyState === WebSocket.OPEN) {
                    refreshServerInfoSilent();
                }
            }, 1000);
        }

        function doReconnect() {
            if (socket) { try { socket.close(); } catch(e) {} }
            if (rconHost && rconPort && rconPassword) {
                connectRcon(rconHost, rconPort, rconPassword);
            } else {
                showLoginScreen();
            }
        }

        function doDisconnect() {
            if (socket) { try { socket.close(); } catch(e) {} }
            socket = null;
            updateConnectionStatus(false);
            pluginsLoaded = false;
            showLoginScreen();
        }

        // ========== PLUGINS ==========
        var pluginFramework = ''; // 'carbon', 'oxide', or ''
        var pluginsLoaded = false;
        var pluginMap = {};       // persistent map: key=lowercase name, val={name,version,author,loaded,failed,raw}
        var pluginRawResponse = '';

        function togglePluginRaw() {
            var sec = document.getElementById('plugins-raw-section');
            sec.classList.toggle('hidden');
            document.getElementById('plugins-raw-output').textContent = pluginRawResponse || '(no response yet)';
        }

        var pluginRefreshInterval = null;

        function refreshPlugins() {
            // Fully reset state so stale data is never shown
            pluginsLoaded = false;
            pluginMap = {};
            pluginRawResponse = '';
            // Clear UI immediately
            var listEl = document.getElementById('plugins-list');
            if (listEl) listEl.innerHTML = '';
            var failedSection = document.getElementById('plugins-failed-section');
            if (failedSection) failedSection.classList.add('hidden');
            detectFrameworkAndLoad();
        }

        function startPluginAutoRefresh() {
            stopPluginAutoRefresh();
            pluginRefreshInterval = setInterval(function() {
                if (socket && socket.readyState === WebSocket.OPEN && document.querySelector('.sidebar-btn[data-tab="plugins"].active')) {
                    detectFrameworkAndLoad();
                }
            }, 5000);
        }

        function stopPluginAutoRefresh() {
            if (pluginRefreshInterval) {
                clearInterval(pluginRefreshInterval);
                pluginRefreshInterval = null;
            }
        }

        function detectFrameworkAndLoad() {
            var frameworkEl = document.getElementById('plugin-framework');
            frameworkEl.textContent = 'Detecting...';

            // Always clear stale state before fetching fresh data
            pluginMap = {};
            pluginRawResponse = '';

            // Try Carbon first
            sendRequest('c.plugins', function(data) {
                var msg = data.Message || '';
                console.log('[Plugins] RAW c.plugins response:', msg);
                if (msg && msg.indexOf('Unknown command') === -1 && msg.indexOf('not recognized') === -1 && msg.trim().length > 10) {
                    pluginFramework = 'carbon';
                    pluginRawResponse = msg;
                    frameworkEl.textContent = '‚ö° Carbon';
                    frameworkEl.className = 'text-xs px-2.5 py-1 rounded-full bg-emerald-900/40 border border-emerald-700/40 text-emerald-400';
                    parsePlugins(msg);
                    return;
                }
                // Try Oxide
                sendRequest('o.plugins', function(data2) {
                    var msg2 = data2.Message || '';
                    console.log('[Plugins] o.plugins response (' + msg2.length + ' chars):', msg2.substring(0, 300));
                    if (msg2 && msg2.indexOf('Unknown command') === -1 && msg2.trim().length > 10) {
                        pluginFramework = 'oxide';
                        pluginRawResponse = msg2;
                        frameworkEl.textContent = 'üî∂ Oxide';
                        frameworkEl.className = 'text-xs px-2.5 py-1 rounded-full bg-orange-900/40 border border-orange-700/40 text-orange-400';
                        parsePlugins(msg2);
                        return;
                    }
                    // Neither found
                    pluginFramework = '';
                    pluginRawResponse = 'c.plugins: ' + msg + '\no.plugins: ' + msg2;
                    frameworkEl.textContent = 'No Framework';
                    frameworkEl.className = 'text-xs px-2.5 py-1 rounded-full bg-slate-700/60 border border-slate-600/40 text-slate-400';
                    pluginsLoaded = true;
                    renderPluginList();
                });
            });
        }

        function parsePlugins(raw) {
            // Clear plugin map on each refresh so removed plugins don't persist
            pluginMap = {};

            // Track which plugins the server reports as loaded this time
            var serverLoaded = {};
            var serverFailed = {};

            // Normalize: server sends literal \n (two chars) as line separators
            var text = raw.replace(/\\n/g, '\n').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            var lines = text.split('\n');
            var hasTabs = text.indexOf('\t') !== -1;

            console.log('[Plugins] Parsing', lines.length, 'lines, hasTabs:', hasTabs);

            // Track sections (Carbon: "* unloaded plugins", "* failed plugins")
            var currentSection = 'loaded'; // 'loaded', 'unloaded', 'failed'

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;

                // Skip column header line
                if (/^#\s/.test(line)) continue;

                // Section headers
                if (/^\*\s*failed\s+plugins?/i.test(line)) { currentSection = 'failed'; continue; }
                if (/^\*\s*unloaded\s+plugins?/i.test(line)) { currentSection = 'unloaded'; continue; }
                if (/^\*\s/.test(line)) { currentSection = 'loaded'; continue; }

                // Oxide-specific meta lines
                if (/^listing\s+/i.test(line)) continue;
                if (/^total:/i.test(line)) continue;
                if (/^\d+\s+plugins?\s+loaded/i.test(line)) continue;

                // Handle failed plugins BEFORE the version check ‚Äî failed lines may not have versions
                if (currentSection === 'failed') {
                    // Skip sub-header lines like "line   stacktrace"
                    if (/^\s*line\s+stacktrace/i.test(line)) continue;
                    // Carbon failed format: "PluginName.cs  11:30  error message"
                    // or just "PluginName  v1.0.0 ..."
                    var fName = '';
                    var fError = '';
                    // Try Carbon .cs format: "Test.cs  11:30  error details"
                    var csMatch = line.match(/^(\S+\.cs)\s+(\d+:\d+)\s+(.*)/i);
                    if (csMatch) {
                        fName = csMatch[1].replace(/\.cs$/i, '');
                        fError = csMatch[3] ? csMatch[3].trim() : '';
                        // Accumulate errors for same plugin
                        var fKey = fName.toLowerCase();
                        if (serverFailed[fKey]) {
                            serverFailed[fKey].errors.push({ line: csMatch[2], message: fError });
                        } else {
                            serverFailed[fKey] = { name: fName, raw: line, errors: [{ line: csMatch[2], message: fError }] };
                        }
                    } else {
                        // Fallback: versioned format or plain name
                        fName = line.replace(/^\d+\.?\s*/, '').replace(/\s+v[\d.]+.*$/, '').replace(/\.cs$/i, '').replace(/"/g, '').trim();
                        if (fName) {
                            var fKey2 = fName.toLowerCase();
                            if (!serverFailed[fKey2]) {
                                serverFailed[fKey2] = { name: fName, raw: line, errors: [] };
                            }
                        }
                    }
                    continue;
                }

                // Skip Carbon package header lines (numbered, NO version pattern)
                if (/^\d+\s+\S/.test(line) && !/v[\d.]+/i.test(line)) continue;

                // Must have a version pattern to be a plugin line
                if (!/v[\d.]+/i.test(line)) continue;

                var pName = '', pAuthor = '', pVersion = '';

                // Strategy 1: Tab-separated columns (Carbon tabular output)
                if (hasTabs) {
                    var cols = line.split('\t');
                    var vIdx = -1;
                    for (var c = 0; c < cols.length; c++) {
                        if (/^v[\d.]+$/i.test(cols[c].trim())) { vIdx = c; break; }
                    }
                    if (vIdx >= 2) {
                        pVersion = cols[vIdx].trim().replace(/^v/i, '');
                        var nameCol = 0;
                        if (/^\d+$/.test(cols[0].trim())) nameCol = 1;
                        pName = cols[nameCol] ? cols[nameCol].trim() : '';
                        pAuthor = (vIdx > nameCol + 1 && cols[nameCol + 1]) ? cols[nameCol + 1].trim() : '';
                    }
                }

                // Strategy 2: Regex-based parsing (space-separated or tab fallback)
                if (!pVersion) {
                    var oxideMatch = line.match(/^\d+\.?\s+"?(.+?)"?\s+(?:\()?v([\d.]+)(?:\))?\s+by\s+(.+?)(?:\s+-|$)/i);
                    if (!oxideMatch) oxideMatch = line.match(/^\d+\.?\s+"?(.+?)"?\s+(?:\()?v([\d.]+)(?:\))?\s+by\s+(.+)/i);

                    if (oxideMatch) {
                        pName = oxideMatch[1].trim();
                        pVersion = oxideMatch[2];
                        pAuthor = oxideMatch[3].trim();
                    } else {
                        var vMatch = line.match(/^(.+?)\s+v([\d.]+)/i);
                        if (!vMatch) continue;

                        var prefix = vMatch[1].trim();
                        pVersion = vMatch[2];
                        prefix = prefix.replace(/^\d+\.?\s+/, '');
                        var cleanPrefix = prefix.replace(/\s*\([^)]*\)\s*$/, '');

                        var byM = cleanPrefix.match(/^(.+?)\s+by\s+(.+)$/i);
                        if (byM) {
                            pName = byM[1].trim();
                            pAuthor = byM[2].trim();
                        } else {
                            var words = cleanPrefix.split(/\s+/);
                            if (words.length >= 2) {
                                var authorStart = words.length - 1;
                                while (authorStart > 1) {
                                    var prev = words[authorStart - 1];
                                    if (prev === '&' || prev === ',' || prev === 'and' || prev.endsWith(',')) {
                                        authorStart -= 2;
                                    } else {
                                        break;
                                    }
                                }
                                if (authorStart < 1) authorStart = words.length - 1;
                                pAuthor = words.slice(authorStart).join(' ').replace(/,\s*$/, '');
                                pName = words.slice(0, authorStart).join(' ');
                            } else {
                                pName = cleanPrefix;
                            }
                        }
                    }
                }

                pName = pName.replace(/"/g, '').trim();
                if (pName && pVersion) {
                    var key = pName.toLowerCase();
                    var isLoaded = (currentSection === 'loaded');
                    if (isLoaded) serverLoaded[key] = true;

                    // Add to persistent map or update existing entry
                    if (!pluginMap[key]) {
                        pluginMap[key] = { name: pName, version: pVersion, author: pAuthor, loaded: isLoaded, failed: false, raw: line };
                    } else {
                        // Update with latest info from server
                        pluginMap[key].version = pVersion;
                        if (pAuthor) pluginMap[key].author = pAuthor;
                        pluginMap[key].loaded = isLoaded;
                        pluginMap[key].failed = false;
                        pluginMap[key].raw = line;
                    }
                }
            }

            // Update loaded state for all known plugins based on server response
            // Remove plugins that no longer appear on the server at all
            Object.keys(pluginMap).forEach(function(key) {
                if (serverLoaded[key]) {
                    pluginMap[key].loaded = true;
                    pluginMap[key].failed = false;
                    pluginMap[key].errors = [];
                } else if (serverFailed[key]) {
                    pluginMap[key].loaded = false;
                    pluginMap[key].failed = true;
                } else {
                    // Plugin no longer reported by server ‚Äî remove it
                    delete pluginMap[key];
                }
            });

            // Add any failed plugins not already in the map (or update existing)
            Object.keys(serverFailed).forEach(function(key) {
                var fp = serverFailed[key];
                if (!pluginMap[key]) {
                    pluginMap[key] = { name: fp.name, version: '', author: '', loaded: false, failed: true, raw: fp.raw, errors: fp.errors || [] };
                } else {
                    pluginMap[key].loaded = false;
                    pluginMap[key].failed = true;
                    pluginMap[key].errors = fp.errors || [];
                }
            });

            pluginsLoaded = true;
            var count = Object.keys(pluginMap).length;
            document.getElementById('plugin-count-badge').textContent = count;
            var loadedCount = 0;
            Object.keys(pluginMap).forEach(function(k) { if (pluginMap[k].loaded) loadedCount++; });
            console.log('[Plugins] Total:', count, 'plugins (' + loadedCount + ' loaded)');

            var rawEl = document.getElementById('plugins-raw-output');
            if (rawEl && !document.getElementById('plugins-raw-section').classList.contains('hidden')) {
                rawEl.textContent = pluginRawResponse;
            }
            renderPluginList();
        }

        function renderPluginList() {
            var listEl = document.getElementById('plugins-list');
            var emptyEl = document.getElementById('plugins-empty');
            var failedSection = document.getElementById('plugins-failed-section');
            var failedListEl = document.getElementById('plugins-failed-list');
            failedSection.classList.add('hidden');

            // Build array from persistent map
            var allPlugins = Object.keys(pluginMap).map(function(k) { return pluginMap[k]; });

            // Show failed plugins banner
            var failedPlugins = allPlugins.filter(function(p) { return p.failed === true; });
            if (failedPlugins.length > 0) {
                failedSection.classList.remove('hidden');
                failedListEl.innerHTML = '';
                failedPlugins.forEach(function(fp) {
                    var item = document.createElement('div');
                    item.className = 'py-2' + (failedPlugins.indexOf(fp) > 0 ? ' border-t border-red-800/20 mt-1' : '');
                    var errorsHtml = '';
                    if (fp.errors && fp.errors.length > 0) {
                        errorsHtml = '<div class="mt-1.5 space-y-0.5">';
                        fp.errors.forEach(function(err) {
                            errorsHtml += '<div class="text-[11px] text-red-400/70 console-font pl-3 flex gap-2">' +
                                '<span class="text-red-400/50 shrink-0">Line ' + escapeHtml(err.line) + '</span>' +
                                '<span>' + escapeHtml(err.message) + '</span>' +
                                '</div>';
                        });
                        errorsHtml += '</div>';
                    }
                    item.innerHTML =
                        '<div class="flex items-center justify-between">' +
                        '<span class="text-sm text-red-300 font-medium">' + escapeHtml(fp.name) + '.cs' + (fp.version ? ' <span class="text-red-400/60 text-xs">v' + escapeHtml(fp.version) + '</span>' : '') + '</span>' +
                        '<button onclick="pluginAction(\'load\', \'' + escapeAttr(fp.name) + '\')" class="text-[11px] px-2 py-1 rounded bg-red-800/30 border border-red-700/30 text-red-400 hover:bg-red-800/50 transition shrink-0">Retry Load</button>' +
                        '</div>' +
                        errorsHtml;
                    failedListEl.appendChild(item);
                });
            }
            var searchTerm = (document.getElementById('plugin-search').value || '').toLowerCase();
            var filtered = allPlugins.filter(function(p) {
                return !searchTerm || p.name.toLowerCase().indexOf(searchTerm) !== -1 || (p.author && p.author.toLowerCase().indexOf(searchTerm) !== -1);
            });

            // Sort: loaded first, then unloaded, then failed, then alphabetical
            filtered.sort(function(a, b) {
                var aOrder = a.failed ? 2 : (a.loaded ? 0 : 1);
                var bOrder = b.failed ? 2 : (b.loaded ? 0 : 1);
                if (aOrder !== bOrder) return aOrder - bOrder;
                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
            });

            if (filtered.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }
            emptyEl.classList.add('hidden');

            listEl.innerHTML = '';
            filtered.forEach(function(p) {
                var isLoaded = p.loaded === true;
                var isFailed = p.failed === true;

                var statusDot, statusBadge, cardOpacity;
                if (isFailed) {
                    statusDot = '<span class="w-2 h-2 rounded-full bg-red-500 mt-1.5 shrink-0" title="Failed"></span>';
                    statusBadge = '<span class="text-[11px] px-1.5 py-0.5 rounded bg-red-900/40 border border-red-800/30 text-red-400 console-font">Failed</span>';
                    cardOpacity = ' opacity-50';
                } else if (!isLoaded) {
                    statusDot = '<span class="w-2 h-2 rounded-full bg-yellow-500 mt-1.5 shrink-0" title="Unloaded"></span>';
                    statusBadge = '<span class="text-[11px] px-1.5 py-0.5 rounded bg-yellow-900/40 border border-yellow-800/30 text-yellow-400 console-font">Unloaded</span>';
                    cardOpacity = ' opacity-70';
                } else {
                    statusDot = '<span class="w-2 h-2 rounded-full bg-green-500 mt-1.5 shrink-0" title="Loaded"></span>';
                    statusBadge = '';
                    cardOpacity = '';
                }

                var buttons = '';
                if (isLoaded) {
                    buttons =
                        '<button onclick="pluginAction(\'reload\', \'' + escapeAttr(p.name) + '\')" class="flex-1 text-[11px] px-2 py-1.5 rounded bg-sky-800/30 border border-sky-700/30 text-sky-400 hover:bg-sky-800/50 transition">Reload</button>' +
                        '<button onclick="pluginAction(\'unload\', \'' + escapeAttr(p.name) + '\')" class="flex-1 text-[11px] px-2 py-1.5 rounded bg-red-800/30 border border-red-700/30 text-red-400 hover:bg-red-800/50 transition">Unload</button>';
                } else {
                    buttons =
                        '<button onclick="pluginAction(\'load\', \'' + escapeAttr(p.name) + '\')" class="flex-1 text-[11px] px-2 py-1.5 rounded bg-green-800/30 border border-green-700/30 text-green-400 hover:bg-green-800/50 transition">Load</button>';
                }

                var card = document.createElement('div');
                card.className = 't-card rounded-lg border p-4 overview-card' + cardOpacity;
                card.innerHTML =
                    '<div class="flex items-start justify-between mb-2">' +
                    '<div class="min-w-0 flex-1">' +
                    '<h3 class="text-sm font-semibold truncate" style="color:var(--text-primary)">' + escapeHtml(p.name) + '</h3>' +
                    '<div class="flex items-center gap-2 mt-0.5">' +
                    (p.version ? '<span class="text-[11px] px-1.5 py-0.5 rounded bg-sky-900/40 border border-sky-800/30 text-sky-400 console-font">v' + escapeHtml(p.version) + '</span>' : '') +
                    statusBadge +
                    (p.author ? '<span class="text-[11px] t-muted">by ' + escapeHtml(p.author) + '</span>' : '') +
                    '</div></div>' +
                    statusDot +
                    '</div>' +
                    '<div class="flex gap-1.5 mt-3">' + buttons + '</div>';
                listEl.appendChild(card);
            });
        }

        function escapeAttr(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function filterPlugins() {
            renderPluginList();
        }

        function pluginAction(action, pluginName) {
            var prefix = pluginFramework === 'carbon' ? 'c.' : 'o.';
            var cmdName = pluginFramework === 'carbon' ? pluginName.replace(/\s+/g, '') : pluginName;
            var cmd = prefix + action + ' ' + cmdName;
            sendRequest(cmd, function(data) {
                var msg = data.Message || '';
                if (msg) {
                    showToast(msg, 'info');
                    appendConsole('[Plugin ' + action + '] ' + msg, action === 'unload' ? 'text-red-400' : 'text-green-400');
                } else {
                    showToast(pluginName + ' ‚Äî ' + action + ' sent', 'success');
                }

                // Update state in the persistent map immediately
                var key = pluginName.toLowerCase();
                if (pluginMap[key]) {
                    if (action === 'unload') {
                        pluginMap[key].loaded = false;
                    } else if (action === 'load' || action === 'reload') {
                        pluginMap[key].loaded = true;
                        pluginMap[key].failed = false;
                    }
                }
                renderPluginList();

                // Also refresh from server after a delay to sync state
                setTimeout(refreshPlugins, 2500);
            });
        }

        // ========== THEME SWITCHER ==========
        function toggleThemeDropdown() {
            var dd = document.getElementById('theme-dropdown');
            dd.classList.toggle('show');
        }

        function setTheme(theme) {
            // Apply theme to <html> element
            if (theme) {
                document.documentElement.setAttribute('data-theme', theme);
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            // Update active dot
            document.querySelectorAll('.theme-dot').forEach(function(dot) {
                dot.classList.remove('active');
            });
            var activeBtn = document.querySelector('[data-theme-btn="' + theme + '"] .theme-dot');
            if (activeBtn) activeBtn.classList.add('active');

            // Save preference
            localStorage.setItem('rcon-theme', theme);

            // Close dropdown
            document.getElementById('theme-dropdown').classList.remove('show');
        }

        // Load saved theme on startup
        (function() {
            var saved = localStorage.getItem('rcon-theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
                document.querySelectorAll('.theme-dot').forEach(function(dot) {
                    dot.classList.remove('active');
                });
                var activeBtn = document.querySelector('[data-theme-btn="' + saved + '"] .theme-dot');
                if (activeBtn) activeBtn.classList.add('active');
            }
        })();

        // Close theme dropdown when clicking outside
        document.addEventListener('click', function(e) {
            var picker = document.querySelector('.theme-picker');
            if (picker && !picker.contains(e.target)) {
                document.getElementById('theme-dropdown').classList.remove('show');
            }
        });

        // ========== KEYBOARD ==========
        document.getElementById('cmd-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                sendFromInput();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (cmdHistoryIndex > 0) {
                    cmdHistoryIndex--;
                    e.target.value = cmdHistory[cmdHistoryIndex] || '';
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (cmdHistoryIndex < cmdHistory.length - 1) {
                    cmdHistoryIndex++;
                    e.target.value = cmdHistory[cmdHistoryIndex] || '';
                } else {
                    cmdHistoryIndex = cmdHistory.length;
                    e.target.value = '';
                }
            }
        });

        // ========== AUTO-REFRESH ==========
        // Track last console.tail timestamp to avoid duplicates
        var lastTailTime = 0;

        // Overview stats are auto-refreshed by startStatsAutoRefresh() every 1s

        // Console log polling: fetch new logs every 3s via console.tail
        // This catches logs even if server doesn't push broadcast messages reliably
        setInterval(function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                sendRequest('console.tail 32', function(data) {
                    var msg = (data.Message || '').trim();
                    try {
                        var lines = JSON.parse(msg);
                        if (Array.isArray(lines)) {
                            lines.forEach(function(line) {
                                var t = line.Time || 0;
                                if (t > lastTailTime) {
                                    handleRconMessage(line);
                                }
                            });
                            // Update lastTailTime to the max time we've seen
                            if (lines.length > 0) {
                                var maxTime = 0;
                                lines.forEach(function(line) {
                                    if ((line.Time || 0) > maxTime) maxTime = line.Time;
                                });
                                if (maxTime > lastTailTime) lastTailTime = maxTime;
                            }
                        }
                    } catch(e) {}
                });
            }
        }, 3000);

        // Players: refresh every 30s (uses sendRequest so it won't pollute console)
        setInterval(function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                sendRequest('playerlist', function(data) {
                    var msg = (data.Message || '').trim();
                    try {
                        var parsed = JSON.parse(msg);
                        if (Array.isArray(parsed)) updatePlayerList(parsed);
                    } catch(e) {}
                });
            }
        }, 30000);

        // ========== START ==========
        // Don't auto-connect ‚Äî wait for login
        startStatsAutoRefresh();
        startPluginAutoRefresh();
    </script>
</body>
</html>
